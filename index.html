<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CRM Dashboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #22263a;
    --border: #2e3348; --accent: #4f6ef7; --accent2: #7c3aed;
    --text: #e2e8f0; --muted: #8892a4; --danger: #ef4444;
    --success: #22c55e; --warning: #f59e0b;
    --radius: 10px; --gap: 12px;
  }
  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; font-size: 14px; overflow-x: hidden; }
  
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LAYOUT RESPONSIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #app { display: flex; height: 100vh; }
  #sidebar {
    width: 220px; min-width: 220px; background: var(--surface); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; transition: transform .25s;
  }
  
  /* Correcci√≥n de Padding en m√≥vil: 12px m√°ximo */
  #main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; width: 100%; }
  #content { padding: 12px; flex: 1; max-width: 100vw; }
  
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TABLE RESPONSIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); width: 100%; }
  table { width: 100%; border-collapse: collapse; }
  
  @media (max-width: 700px) {
    #sidebar { position: fixed; top: 0; left: 0; height: 100%; z-index: 50; transform: translateX(-100%); }
    #sidebar.open { transform: translateX(0); }
    #content { padding: 10px 8px; } /* Padding reducido para evitar desbordamiento */
    
    /* Transformaci√≥n de tabla en tarjetas para evitar scroll horizontal */
    .card-table thead { display: none; }
    .card-table tbody tr {
      display: block; border: 1px solid var(--border); border-radius: 8px;
      margin-bottom: 8px; padding: 12px; background: var(--surface);
    }
    .card-table td { display: flex; justify-content: space-between; padding: 4px 0; border: none; font-size: 13px; text-align: right; }
    .card-table td::before { content: attr(data-label); font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; text-align: left; }
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MARCAS GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .marcas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
  .marca-card { 
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px;
    display: flex; flex-direction: column; gap: 8px; transition: transform 0.2s;
  }
  .marca-card:hover { transform: translateY(-2px); border-color: var(--accent); }
  .marca-nombre { font-weight: 800; color: var(--accent); white-space: normal; word-break: break-word; font-size: 15px; }
</style>
</head>
<body>

<div id="login-screen">
  <div class="login-card">
    <h2>üè¢ CRM Leads</h2>
    <p>Accede con tu cuenta corporativa</p>
    <div class="field"><label>Email</label><input id="l-email" type="email" placeholder="tu@email.com"></div>
    <div class="field"><label>Contrase√±a</label><input id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px" onclick="doLogin()">Entrar</button>
    <div id="login-err" style="color:var(--danger);font-size:12px;margin-top:10px;display:none"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div id="sidebar">
    <div style="padding: 20px; font-weight: 800; color: var(--accent);">‚ö° CRM UNIFICADO</div>
    <nav id="sidebar-nav"></nav>
    <div id="sidebar-footer" style="padding: 15px; border-top: 1px solid var(--border);">
        <div id="user-info" style="font-size: 11px; color: var(--muted); margin-bottom: 10px;"></div>
        <button class="btn btn-outline" style="width:100%" onclick="doLogout()">Salir</button>
    </div>
  </div>
  <div id="main">
    <div id="topbar" style="padding: 12px 16px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:20px;">‚ò∞</button>
      <h1 id="page-title" style="font-size: 16px;">Dashboard</h1>
      <button class="btn btn-icon btn-outline" onclick="refreshCurrentView()">‚Üª</button>
    </div>
    <div id="content"></div>
  </div>
</div>

<script>
// CONFIGURACI√ìN SUPABASE
const SUPA_URL = 'https://uzmlyawikzqvdoeubrwy.supabase.co';
const SUPA_KEY = 'sb_publishable_-mdEhWbnK-ampAx3EoxrYQ_n7Bu4Dr1';

// FUNCI√ìN MAESTRA ANTIFALLOS PARA "MIS MARCAS"
async function loadMisMarcas() {
  try {
    const userId = currentUser.id;
    // Paso 1: Petici√≥n plana de IDs
    const resIds = await fetch(`${SUPA_URL}/rest/v1/gestor_marcas?gestor_id=eq.${userId}&select=marca_id`, {
        headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${currentSession.access_token}` }
    });
    const gestorRows = await resIds.json();
    if (!gestorRows.length) return [];
    
    const arrayIds = gestorRows.map(r => r.marca_id);
    
    // Paso 2: Petici√≥n limpia a la tabla marcas
    const inParam = `(${arrayIds.join(',')})`;
    const resMarcas = await fetch(`${SUPA_URL}/rest/v1/marcas?id=in.${inParam}&select=*`, {
        headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${currentSession.access_token}` }
    });
    const marcas = await resMarcas.json();
    
    // Paso 3: Cruce con empresasMap de memoria
    return marcas.map(m => ({
      ...m,
      empresa_nombre: empresasMap[m.empresa_id]?.nombre_comercial || 'Sin empresa'
    }));
  } catch (err) {
    console.error("Error en Fetch Marcas:", err);
    throw new Error("No se pudo conectar con la base de datos de marcas.");
  }
}

// RESTO DE L√ìGICA DE NAVEGACI√ìN Y DASHBOARD MINIMALISTA
async function renderDashboard() {
  const c = document.getElementById('content');
  if (userRole === 'empresa') {
      // Si es empresa, vamos directo a los leads (minimalismo)
      return navigateTo('leads');
  }
  
  // Dashboard Gestor con KPIs compactos
  try {
    const leads = await loadLeads();
    const total = leads.length;
    c.innerHTML = `
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-val">${total}</div><div class="kpi-label">Leads</div></div>
        <div class="kpi-card"><div class="kpi-val" style="color:var(--success)">${leads.filter(l=>l.estado==='ganado').length}</div><div class="kpi-label">Ganados</div></div>
      </div>
      ${renderLeadsTable(leads.slice(0, 15))}
    `;
  } catch(e) { c.innerHTML = `Error: ${e.message}`; }
}

// (Pega aqu√≠ el resto de tus funciones de login y helpers del archivo original)
// ... [Mantenemos doLogin, supaFetch, renderLeads, etc. del c√≥digo original] ...

</script>
</body>
</html>
