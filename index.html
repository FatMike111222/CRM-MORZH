
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Unificado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:    #060911; --s1: #0c1322; --s2: #101929; --s3: #172034;
      --bd:    #1d2e47; --bd2: #27415f; --txt: #c5d5e8; --muted: #3d5a78;
      --hi:    #e6f0ff; --blue: #3b7dd8; --blue2: #5b6ef0;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--txt); min-height: 100vh; }
    h1,h2,h3 { font-family: 'Syne', sans-serif; }
    .mono { font-family: 'DM Mono', monospace; }

    body::before {
      content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background-image: linear-gradient(rgba(59,125,216,.028) 1px,transparent 1px),
                        linear-gradient(90deg,rgba(59,125,216,.028) 1px,transparent 1px);
      background-size: 44px 44px;
    }
    #screen-login, #screen-app { position: relative; z-index: 1; }
    #screen-login { display: flex; }
    #screen-app   { display: none; flex-direction: column; min-height: 100vh; }

    /* â”€â”€ Login â”€â”€ */
    .login-box { background: var(--s2); border: 1px solid var(--bd); border-radius: 18px; padding: 40px 36px; box-shadow: 0 40px 80px rgba(0,0,0,.65), 0 0 0 1px rgba(255,255,255,.025) inset; }
    .accent-bar { height: 3px; background: linear-gradient(90deg, var(--blue), var(--blue2), transparent); border-radius: 18px 18px 0 0; }
    .logo-sq { width: 38px; height: 38px; border-radius: 9px; background: linear-gradient(135deg, var(--blue), var(--blue2)); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(59,125,216,.4); }

    /* â”€â”€ Topbar â”€â”€ */
    .topbar { background: rgba(6,9,17,.9); border-bottom: 1px solid var(--bd); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 50; }
    .topbar-inner { width: 94%; max-width: 100%; margin: 0 auto; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .tab-bar { display: flex; gap: 3px; background: var(--s1); border: 1px solid var(--bd); border-radius: 10px; padding: 4px; }
    .tab { font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 500; color: var(--muted); background: none; border: none; border-radius: 7px; padding: 7px 18px; cursor: pointer; transition: all .18s; white-space: nowrap; }
    .tab:hover { color: var(--txt); background: rgba(255,255,255,.04); }
    .tab.active { background: var(--s3); color: var(--hi); border: 1px solid var(--bd2); box-shadow: 0 2px 8px rgba(0,0,0,.3); }

    .badge { font-family: 'DM Mono', monospace; font-size: .63rem; background: rgba(59,125,216,.14); border: 1px solid rgba(59,125,216,.28); color: #7eb4f8; padding: 3px 10px; border-radius: 99px; letter-spacing: .05em; }
    .badge-empresa { background: rgba(139,92,246,.14); border-color: rgba(139,92,246,.28); color: #c4b5fd; }
    .btn-ghost { font-family: 'DM Sans', sans-serif; font-size: .75rem; font-weight: 500; background: rgba(255,255,255,.04); border: 1px solid var(--bd); color: var(--muted); border-radius: 8px; padding: 6px 13px; cursor: pointer; transition: color .18s, border-color .18s; }
    .btn-ghost:hover { color: #f87171; border-color: rgba(248,113,113,.3); }

    .main { width: 94%; max-width: 100%; margin: 0 auto; padding: 28px 20px 52px; }
    @media(max-width:768px) { .main { width: 100%; padding: 16px 12px 40px; } }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fadein .28s ease both; }
    @keyframes fadein { from { opacity:0; transform:translateY(7px); } to { opacity:1; transform:translateY(0); } }

    .pcard { background: var(--s2); border: 1px solid var(--bd); border-radius: 16px; overflow: hidden; }
    .pcard-head { padding: 18px 22px; border-bottom: 1px solid var(--bd); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .pcard-title { font-family: 'Syne', sans-serif; font-size: .92rem; font-weight: 700; color: var(--hi); }
    .pcard-body { padding: 22px; }

    /* â”€â”€ Fields â”€â”€ */
    .field-label { display: block; font-size: .7rem; font-weight: 600; letter-spacing: .09em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .field { width: 100%; background: rgba(255,255,255,.03); border: 1px solid var(--bd); border-radius: 9px; color: var(--txt); font-family: 'DM Sans', sans-serif; font-size: .875rem; padding: 10px 13px; outline: none; transition: border-color .18s, box-shadow .18s; appearance: none; -webkit-appearance: none; }
    .field::placeholder { color: var(--muted); }
    .field:focus { border-color: rgba(59,125,216,.55); box-shadow: 0 0 0 3px rgba(59,125,216,.1); }
    .field option { background: var(--s1); }
    select.field { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233d5a78'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }

    /* â”€â”€ Buttons â”€â”€ */
    .btn-primary { background: linear-gradient(135deg, var(--blue), var(--blue2)); border: none; border-radius: 9px; color: #fff; font-family: 'DM Sans', sans-serif; font-size: .875rem; font-weight: 600; padding: 11px 24px; cursor: pointer; transition: transform .15s, box-shadow .18s, opacity .18s; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(91,110,240,.4); }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
    .btn-sm { font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 600; border: none; border-radius: 7px; padding: 7px 14px; cursor: pointer; transition: all .15s; }
    .btn-sm-green { background: rgba(34,197,94,.15); color: #4ade80; border: 1px solid rgba(34,197,94,.3); }
    .btn-sm-green:hover { background: rgba(34,197,94,.25); }

    .form-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media(max-width:600px) { .form-2col { grid-template-columns: 1fr; } }
    .col-span-2 { grid-column: 1 / -1; }

    .alert { border-radius: 9px; font-size: .83rem; padding: 10px 14px; display: none; }
    .alert.ok  { background: rgba(34,197,94,.1);  border: 1px solid rgba(34,197,94,.3);  color: #86efac; }
    .alert.err { background: rgba(239,68,68,.1);  border: 1px solid rgba(239,68,68,.3);  color: #fca5a5; }
    .alert.show { display: flex; align-items: flex-start; gap: 8px; }

    /* â”€â”€ KPIs â”€â”€ */
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .kpi { background: var(--s3); border: 1px solid var(--bd); border-radius: 14px; padding: 20px 18px; transition: border-color .18s, transform .18s; }
    .kpi:hover { border-color: var(--bd2); transform: translateY(-1px); }
    .kpi-lbl { font-size: .62rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-bottom: 10px; }
    .kpi-val { font-family: 'Syne', sans-serif; font-size: 2.1rem; font-weight: 800; line-height: 1; }

    /* â”€â”€ Stats cards â”€â”€ */
    .emp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .emp-card { background: var(--s3); border: 1px solid var(--bd); border-radius: 13px; padding: 16px 18px; transition: border-color .18s; }
    .emp-card:hover { border-color: var(--bd2); }
    .emp-name { font-family: 'Syne', sans-serif; font-size: .85rem; font-weight: 700; color: var(--hi); margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .emp-row  { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: .78rem; }
    .emp-row:last-child { margin-bottom: 0; }
    .estat-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; display: inline-block; margin-right: 6px; }

    /* â”€â”€ Marca cards (Mis Marcas) â”€â”€ */
    #marcas-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; gap: 10px; }
    .marca-card {
      background: #101929;
      border: 1px solid #1d2e47;
      border-radius: 11px;
      padding: 13px 15px;
      display: flex; flex-direction: column; gap: 9px;
      transition: background .22s, border-color .22s;
    }
    .marca-card:hover {
      background: #0d1f38;
      border-color: #2a4a6e;
    }
    .marca-nombre {
      font-family: 'Syne', sans-serif;
      font-size: .92rem; font-weight: 800;
      color: #7eb4f8;
      line-height: 1.3;
      word-break: break-word;
      white-space: normal;
    }
    .marca-empresa-row {
      display: flex; align-items: flex-start; gap: 6px;
      border-top: 1px solid #1d2e47; padding-top: 8px; margin-top: 1px;
    }
    .marca-empresa-lbl {
      font-size: .61rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .08em; color: var(--muted);
      white-space: nowrap; padding-top: 2px; flex-shrink: 0;
    }
    .marca-empresa-val {
      font-size: .81rem; color: var(--txt); font-weight: 400;
      word-break: break-word; line-height: 1.35;
    }

    /* â”€â”€ Filtros de sector en Mis Marcas â”€â”€ */
    .sector-filter {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 18px;
    }
    .sf-btn {
      font-family: 'DM Sans', sans-serif; font-size: .75rem; font-weight: 500;
      padding: 5px 14px; border-radius: 99px; cursor: pointer;
      border: 1px solid var(--bd); background: rgba(255,255,255,.03);
      color: var(--muted); transition: all .16s;
    }
    .sf-btn:hover { color: var(--txt); border-color: var(--bd2); }
    .sf-btn.active {
      background: rgba(59,125,216,.18); border-color: rgba(59,125,216,.5);
      color: #7eb4f8;
    }
    @media(max-width:768px) {
      #marcas-grid { grid-template-columns: 1fr !important; }
      .emp-grid    { grid-template-columns: 1fr; }
      .kpi-row     { grid-template-columns: repeat(2, 1fr); }
    }

    /* â”€â”€ Pills â”€â”€ */
    .pill { font-family: 'DM Mono', monospace; font-size: .63rem; font-weight: 600; letter-spacing: .04em; border-radius: 99px; padding: 3px 9px; border: 1px solid transparent; white-space: nowrap; }
    .s-pendiente  { background: rgba(245,166,35,.13); border-color: rgba(245,166,35,.4);  color: #f5a623; }
    .s-visita     { background: rgba(59,125,216,.13);  border-color: rgba(59,125,216,.4);  color: #63a8f8; }
    .s-seguimiento{ background: rgba(139,92,246,.13);  border-color: rgba(139,92,246,.4);  color: #a78bfa; }
    .s-presupuesto{ background: rgba(249,115,22,.13);  border-color: rgba(249,115,22,.4);  color: #fb923c; }
    .s-aceptada   { background: rgba(34,197,94,.13);   border-color: rgba(34,197,94,.4);   color: #4ade80; }
    .s-trabajando { background: rgba(20,184,166,.13);  border-color: rgba(20,184,166,.4);  color: #2dd4bf; }
    .s-rechazado  { background: rgba(239,68,68,.13);   border-color: rgba(239,68,68,.4);   color: #f87171; }

    /* â”€â”€ Table â”€â”€ */
    .tbl-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    thead th { background: rgba(12,19,34,.98); color: var(--muted); font-size: .65rem; font-weight: 700; text-transform: uppercase; letter-spacing: .09em; padding: 11px 16px; border-bottom: 1px solid var(--bd); text-align: left; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid rgba(29,46,71,.5); transition: background .14s; cursor: pointer; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(59,125,216,.07); }
    tbody td { padding: 11px 16px; font-size: .83rem; vertical-align: middle; }
    .row-hint { font-size: .65rem; color: var(--muted); white-space: nowrap; }

    /* â”€â”€ Realtime dot â”€â”€ */
    .rt-live { display: inline-flex; align-items: center; gap: 5px; font-family: 'DM Mono', monospace; font-size: .6rem; color: #4ade80; letter-spacing: .06em; }
    .rt-live::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #4ade80; animation: rt-blink 1.8s ease-in-out infinite; }
    @keyframes rt-blink { 0%,100% { opacity: 1; box-shadow: 0 0 4px #4ade80; } 50% { opacity: .4; box-shadow: none; } }

    /* â”€â”€ Notif badge â”€â”€ */
    .new-comment-dot { display: inline-flex; align-items: center; gap: 5px; background: rgba(239,68,68,.13); border: 1px solid rgba(239,68,68,.35); color: #f87171; font-size: .62rem; font-weight: 700; letter-spacing: .04em; padding: 2px 7px; border-radius: 99px; animation: pulse-red 2s ease-in-out infinite; white-space: nowrap; }
    .new-comment-dot::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,.8); }
    @keyframes pulse-red { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } 50% { box-shadow: 0 0 0 3px rgba(239,68,68,.15); } }

    /* â”€â”€ Spinners â”€â”€ */
    .spin    { width: 20px; height: 20px; border: 2px solid rgba(59,125,216,.2); border-top-color: var(--blue); border-radius: 50%; animation: spin .65s linear infinite; margin: 40px auto; }
    .spin-sm { width: 14px; height: 14px; border: 2px solid rgba(59,125,216,.2); border-top-color: var(--blue); border-radius: 50%; animation: spin .65s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty { padding: 40px 20px; text-align: center; color: var(--muted); font-size: .84rem; }
    .dot-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--blue); flex-shrink: 0; animation: dpulse 2.2s ease-in-out infinite; }
    @keyframes dpulse { 0%,100% { box-shadow: 0 0 6px var(--blue); } 50% { box-shadow: 0 0 16px var(--blue), 0 0 28px rgba(59,125,216,.25); } }
    .sec-divider { border: none; border-top: 1px solid var(--bd); margin: 24px 0; }

    /* â”€â”€ Toast â”€â”€ */
    #toast { position: fixed; bottom: 22px; right: 22px; z-index: 200; padding: 10px 16px; border-radius: 10px; font-size: .82rem; font-weight: 500; display: none; align-items: center; gap: 7px; backdrop-filter: blur(12px); box-shadow: 0 8px 24px rgba(0,0,0,.45); }
    #toast.ok  { background: rgba(34,197,94,.14); border: 1px solid rgba(34,197,94,.3); color: #86efac; }
    #toast.err { background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.3); color: #fca5a5; }
    #toast.show { display: flex; }

    /* â”€â”€ Modal â”€â”€ */
    #modal-backdrop { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(4,7,15,.8); backdrop-filter: blur(6px); align-items: flex-start; justify-content: center; padding: 32px 16px; overflow-y: auto; }
    #modal-backdrop.open { display: flex; animation: fadein .22s ease both; }
    #modal-box { background: var(--s1); border: 1px solid var(--bd2); border-radius: 18px; width: 100%; max-width: 780px; box-shadow: 0 40px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.03) inset; overflow: hidden; flex-shrink: 0; animation: modalin .25s cubic-bezier(.16,1,.3,1) both; }
    @keyframes modalin { from { opacity:0; transform:scale(.97) translateY(12px); } to { opacity:1; transform:scale(1) translateY(0); } }
    .modal-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--bd); display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
    .modal-close { background: rgba(255,255,255,.05); border: 1px solid var(--bd); color: var(--muted); border-radius: 7px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; flex-shrink: 0; transition: color .15s, background .15s; }
    .modal-close:hover { background: rgba(248,113,113,.12); color: #f87171; border-color: rgba(248,113,113,.3); }
    .modal-body { padding: 0; }
    .modal-tabs { display: flex; border-bottom: 1px solid var(--bd); background: var(--s2); }
    .mtab { font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 500; color: var(--muted); background: none; border: none; border-bottom: 2px solid transparent; padding: 12px 20px; cursor: pointer; transition: all .18s; white-space: nowrap; margin-bottom: -1px; }
    .mtab:hover { color: var(--txt); }
    .mtab.active { color: var(--hi); border-bottom-color: var(--blue); }
    .mpanel { display: none; padding: 22px 24px; }
    .mpanel.active { display: block; animation: fadein .2s ease both; }

    /* â”€â”€ Info grid â”€â”€ */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    @media(max-width:520px) { .info-grid { grid-template-columns: 1fr; } }
    .info-item { background: var(--s3); border: 1px solid var(--bd); border-radius: 9px; padding: 11px 14px; }
    .info-item-lbl { font-size: .63rem; font-weight: 600; text-transform: uppercase; letter-spacing: .09em; color: var(--muted); margin-bottom: 4px; }
    .info-item-val { font-size: .85rem; color: var(--hi); word-break: break-word; }

    /* â”€â”€ Editable inputs dentro de info-item â”€â”€ */
    .info-item-input { width: 100%; background: rgba(255,255,255,.04); border: 1px solid var(--bd2); border-radius: 6px; color: var(--hi); font-family: 'DM Sans', sans-serif; font-size: .85rem; padding: 5px 8px; outline: none; transition: border-color .18s; margin-top: 2px; }
    .info-item-input:focus { border-color: rgba(59,125,216,.55); box-shadow: 0 0 0 2px rgba(59,125,216,.1); }
    .info-item-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.6); cursor: pointer; }

    /* â”€â”€ Selector de estado en la ficha â”€â”€ */
    .estado-selector { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 14px; }
    .estado-opt { font-family: 'DM Mono', monospace; font-size: .62rem; font-weight: 600; letter-spacing: .04em; border-radius: 99px; padding: 4px 11px; border: 1px solid var(--bd); cursor: pointer; background: rgba(255,255,255,.03); color: var(--muted); transition: all .15s; }
    .estado-opt:hover { color: var(--txt); border-color: var(--bd2); }
    .estado-opt.selected { color: #fff; border-color: transparent; }
    .estado-opt.selected.s-pendiente   { background: rgba(245,166,35,.55); }
    .estado-opt.selected.s-visita      { background: rgba(59,125,216,.55); }
    .estado-opt.selected.s-seguimiento { background: rgba(139,92,246,.55); }
    .estado-opt.selected.s-presupuesto { background: rgba(249,115,22,.55); }
    .estado-opt.selected.s-aceptada    { background: rgba(34,197,94,.55); }
    .estado-opt.selected.s-trabajando  { background: rgba(20,184,166,.55); }
    .estado-opt.selected.s-rechazado   { background: rgba(239,68,68,.55); }

    /* â”€â”€ Save bar â”€â”€ */
    .save-bar { display: none; align-items: center; gap: 10px; margin-top: 18px; padding-top: 16px; border-top: 1px solid var(--bd); }
    .save-bar.visible { display: flex; }

    /* â”€â”€ Comments â”€â”€ */
    #comments-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; max-height: 340px; overflow-y: auto; padding-right: 4px; }
    #comments-list::-webkit-scrollbar { width: 4px; }
    #comments-list::-webkit-scrollbar-track { background: transparent; }
    #comments-list::-webkit-scrollbar-thumb { background: var(--bd2); border-radius: 4px; }
    .comment-bubble { background: var(--s3); border: 1px solid var(--bd); border-radius: 12px; padding: 12px 14px; border-left: 3px solid var(--blue); animation: fadein .2s ease both; }
    .comment-bubble.sistema { border-left-color: #a78bfa; background: rgba(139,92,246,.06); }
    .comment-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; flex-wrap: wrap; }
    .comment-author { font-size: .75rem; font-weight: 600; color: #7eb4f8; }
    .comment-author.sistema { color: #a78bfa; }
    .comment-date   { font-size: .68rem; color: var(--muted); font-family: 'DM Mono', monospace; }
    .comment-text   { font-size: .84rem; color: var(--txt); line-height: 1.55; white-space: pre-wrap; }
    .comment-composer { display: flex; gap: 10px; align-items: flex-end; }
    .comment-composer textarea { flex: 1; min-height: 70px; background: rgba(255,255,255,.03); border: 1px solid var(--bd); border-radius: 9px; color: var(--txt); font-family: 'DM Sans', sans-serif; font-size: .84rem; padding: 10px 12px; outline: none; resize: vertical; transition: border-color .18s; }
    .comment-composer textarea:focus { border-color: rgba(59,125,216,.5); }
    .comment-composer textarea::placeholder { color: var(--muted); }

    /* â”€â”€ Documents â”€â”€ */
    .drop-zone { border: 2px dashed var(--bd2); border-radius: 12px; padding: 28px 20px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: border-color .2s, background .2s; position: relative; }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--blue); background: rgba(59,125,216,.06); }
    .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .drop-zone-icon { font-size: 1.6rem; margin-bottom: 8px; }
    .drop-zone p { font-size: .82rem; color: var(--muted); }
    .drop-zone strong { color: var(--txt); }
    .drop-zone-hint { font-size: .7rem; color: var(--muted); margin-top: 5px; }
    .doc-list { display: flex; flex-direction: column; gap: 8px; }
    .doc-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; background: var(--s3); border: 1px solid var(--bd); border-radius: 9px; padding: 10px 13px; }
    .doc-icon { font-size: 1.1rem; flex-shrink: 0; }
    .doc-name { font-size: .82rem; color: var(--txt); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .doc-size { font-size: .7rem; color: var(--muted); font-family: 'DM Mono', monospace; white-space: nowrap; }
    .upload-progress { height: 3px; background: var(--bd); border-radius: 99px; margin-top: 6px; overflow: hidden; }
    .upload-progress-bar { height: 100%; background: linear-gradient(90deg, var(--blue), var(--blue2)); border-radius: 99px; transition: width .3s ease; }

    /* â”€â”€ SemÃ¡foro de fechas â”€â”€ */
    .fecha-ok  { color: #4ade80; font-weight: 600; }   /* a tiempo / futura */
    .fecha-bad { color: #f87171; font-weight: 600; }   /* atrasada */
    .fecha-nil { color: var(--muted); }                /* sin fecha */

    /* â”€â”€ Bloque destacado en el modal (PrÃ³xima AcciÃ³n + Importe) â”€â”€ */
    .destaque-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
    @media(max-width:480px){ .destaque-row { grid-template-columns: 1fr; } }
    .destaque-card {
      border-radius: 13px; padding: 16px 18px;
      border: 1px solid var(--bd2);
      display: flex; flex-direction: column; gap: 4px;
    }
    .destaque-card.accion  { background: rgba(59,125,216,.08); border-color: rgba(59,125,216,.3); }
    .destaque-card.importe { background: rgba(34,197,94,.07);  border-color: rgba(34,197,94,.25); }
    .destaque-lbl  { font-size: .6rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); }
    .destaque-val  { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; line-height: 1.15; color: var(--hi); }
    .destaque-sub  { font-size: .72rem; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ Subline de datos en header del modal â”€â”€ */
    #modal-subline { font-size: .75rem; color: var(--muted); margin-top: 5px; display: flex; flex-wrap: wrap; gap: 0; align-items: center; }
    #modal-subline .sep { margin: 0 6px; opacity: .35; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="items-center justify-center min-h-screen px-4 py-12">
  <div class="w-full max-w-[410px]">
    <div class="login-box">
      <div class="accent-bar" style="margin:-40px -36px 32px;border-radius:18px 18px 0 0"></div>
      <div style="display:flex;align-items:center;gap:13px;margin-bottom:28px">
        <div class="logo-sq">
          <svg width="18" height="18" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div>
          <p class="mono" style="font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted)">Red Comercial</p>
          <h1 style="font-size:1.15rem;color:var(--hi)">Panel de Acceso</h1>
        </div>
      </div>
      <div id="err-login" class="alert err" style="margin-bottom:16px">
        <svg style="width:14px;height:14px;flex-shrink:0;margin-top:1px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span id="err-login-txt"></span>
      </div>
      <form id="form-login" novalidate>
        <div style="margin-bottom:14px">
          <label class="field-label" for="l-email">Email</label>
          <input id="l-email" type="email" required placeholder="usuario@email.com" class="field"/>
        </div>
        <div style="margin-bottom:22px">
          <label class="field-label" for="l-pass">ContraseÃ±a</label>
          <input id="l-pass" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="field"/>
        </div>
        <button id="btn-login" type="submit" class="btn-primary" style="width:100%">Iniciar sesiÃ³n</button>
      </form>
    </div>
    <p style="text-align:center;font-size:.72rem;color:var(--muted);margin-top:18px">Acceso exclusivo Â· Gestores y Empresas autorizadas</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-app">
  <nav class="topbar">
    <div style="height:2px;background:linear-gradient(90deg,var(--blue),var(--blue2),transparent)"></div>
    <div class="topbar-inner">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div class="dot-pulse"></div>
        <div>
          <p id="topbar-role-lbl" class="mono" style="font-size:.57rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)">Panel</p>
          <p id="user-display-name" style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:var(--hi);line-height:1.2">Cargandoâ€¦</p>
        </div>
        <div style="width:1px;height:20px;background:var(--bd);margin:0 4px"></div>
        <div class="tab-bar">
          <button id="tab-btn-form"   class="tab active" data-tab="tab-form"><span style="margin-right:5px">âœ¦</span>Registrar Lead</button>
          <button id="tab-btn-dash"   class="tab" data-tab="tab-dash"><span style="margin-right:5px">â—ˆ</span>Dashboard</button>
          <button id="tab-btn-marcas" class="tab" data-tab="tab-marcas" style="display:none"><span style="margin-right:5px">ğŸ·ï¸</span>Mis Marcas</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="user-badge" class="badge mono"></span>
        <button id="btn-logout" class="btn-ghost">Salir</button>
      </div>
    </div>
  </nav>

  <div class="main">

    <!-- â•â• TAB 1: FORMULARIO (solo gestores) â•â• -->
    <div id="tab-form" class="tab-panel active">
      <div class="pcard" style="max-width:720px;margin:0 auto">
        <div class="pcard-head">
          <div>
            <div class="pcard-title">Alta de Nuevo Lead</div>
            <p style="font-size:.76rem;color:var(--muted);margin-top:3px">Todos los campos son opcionales</p>
          </div>
          <span class="badge mono" id="gestor-badge-form"></span>
        </div>
        <div class="pcard-body">
          <div id="form-ok" class="alert ok" style="margin-bottom:18px">
            <svg style="width:14px;height:14px;flex-shrink:0;margin-top:1px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            <span>Lead registrado correctamente. Formulario listo para el siguiente.</span>
          </div>
          <div id="form-err" class="alert err" style="margin-bottom:18px">
            <svg style="width:14px;height:14px;flex-shrink:0;margin-top:1px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span id="form-err-txt"></span>
          </div>
          <form id="form-lead" novalidate>
            <div class="form-2col">
              <div><label class="field-label" for="f-nombre">Nombre cliente</label><input id="f-nombre" type="text" placeholder="Ej: Carmen Rivas" class="field"/></div>
              <div><label class="field-label" for="f-tel">TelÃ©fono</label><input id="f-tel" type="text" placeholder="6XX XXX XXX" class="field"/></div>
              <div><label class="field-label" for="f-email">Email</label><input id="f-email" type="email" placeholder="cliente@email.com" class="field"/></div>
              <div><label class="field-label" for="f-pobl">PoblaciÃ³n</label><input id="f-pobl" type="text" placeholder="Ciudad o municipio" class="field"/></div>
              <div>
                <label class="field-label" for="f-sector">Sector</label>
                <!-- Bloqueado automÃ¡ticamente si el usuario solo tiene un sector -->
                <select id="f-sector" class="field">
                  <option value="">â€” Seleccionar â€”</option>
                </select>
              </div>
              <div>
                <label class="field-label" for="f-reforma">Subservicio</label>
                <!-- Se puebla dinÃ¡micamente segÃºn el sector elegido -->
                <select id="f-reforma" class="field" disabled>
                  <option value="">â€” Elige un sector primero â€”</option>
                </select>
              </div>
              <div><label class="field-label" for="f-marca">Marca</label><select id="f-marca" class="field"><option value="">â€” Seleccionar â€”</option></select></div>
              <div class="col-span-2"><label class="field-label" for="f-empresa">Empresa</label><select id="f-empresa" class="field"><option value="">â€” Seleccionar â€”</option></select></div>
            </div>
            <div style="margin-top:16px">
              <label class="field-label" for="f-extra">
                InformaciÃ³n extra para la empresa
                <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted);margin-left:6px">(opcional Â· se guardarÃ¡ como nota interna)</span>
              </label>
              <textarea id="f-extra" rows="3"
                placeholder="Escribe aquÃ­ cualquier detalle adicional que deba ver la empresaâ€¦"
                style="width:100%;background:rgba(255,255,255,.03);border:1px solid var(--bd);border-radius:9px;color:var(--txt);font-family:'DM Sans',sans-serif;font-size:.875rem;padding:10px 13px;outline:none;resize:vertical;transition:border-color .18s,box-shadow .18s;"
                onfocus="this.style.borderColor='rgba(59,125,216,.55)';this.style.boxShadow='0 0 0 3px rgba(59,125,216,.1)'"
                onblur="this.style.borderColor='';this.style.boxShadow=''"></textarea>
            </div>
            <hr class="sec-divider"/>
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
              <p style="font-size:.75rem;color:var(--muted)">Estado inicial: <span class="pill s-pendiente" style="margin-left:4px">PENDIENTE DE LLAMAR</span></p>
              <button id="btn-lead-submit" type="submit" class="btn-primary">Registrar lead</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- â•â• TAB 2: DASHBOARD â•â• -->
    <div id="tab-dash" class="tab-panel">
      <div style="display:flex;justify-content:flex-end;margin-bottom:18px">
        <button id="btn-refresh" class="btn-ghost">â†» Actualizar datos</button>
      </div>
      <div id="kpi-row" class="kpi-row"><div class="kpi"><p class="kpi-lbl">Cargandoâ€¦</p></div></div>
      <div class="pcard" style="margin-bottom:24px">
        <div class="pcard-head">
          <div class="pcard-title" id="stats-card-title">Rendimiento por Empresa</div>
          <span style="font-size:.72rem;color:var(--muted)">DistribuciÃ³n de estados</span>
        </div>
        <div class="pcard-body"><div id="emp-grid" class="emp-grid"><div class="empty">Cargandoâ€¦</div></div></div>
      </div>
      <div class="pcard">
        <div class="pcard-head">
          <div class="pcard-title">Seguimiento de Leads</div>
          <span style="font-size:.72rem;color:var(--muted)">Haz clic en una fila para abrir la ficha</span>
        </div>
        <div id="tbl-loading"><div class="spin"></div></div>
        <div id="tbl-empty" class="empty" style="display:none">No hay leads registrados aÃºn.</div>
        <div id="tbl-wrap" class="tbl-wrap" style="display:none">
          <table>
            <thead>
              <tr>
                <th>Cliente</th><th>TelÃ©fono</th><th>PoblaciÃ³n</th>
                <th>Tipo reforma</th><th>Empresa</th><th>Marca</th>
                <th>Estado</th><th>PrÃ³xima AcciÃ³n</th><th></th>
              </tr>
            </thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
      </div>
    </div><!-- /tab-dash -->

    <!-- â•â• TAB 3: MIS MARCAS (solo gestores) â•â• -->
    <div id="tab-marcas" class="tab-panel">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">
        <div>
          <p class="pcard-title" style="font-size:1.05rem">ğŸ·ï¸ Mis Marcas</p>
          <p style="font-size:.76rem;color:var(--muted);margin-top:3px">Marcas asignadas y empresa instaladora vinculada</p>
        </div>
        <button id="btn-refresh-marcas" class="btn-ghost">â†» Actualizar</button>
      </div>
      <!-- Filtros de sector -->
      <div class="sector-filter" id="sector-filter">
        <button class="sf-btn active" data-sector="todas"    onclick="filterMarcas('todas')">Todas</button>
        <button class="sf-btn"        data-sector="reformas" onclick="filterMarcas('reformas')">Reformas</button>
        <button class="sf-btn"        data-sector="limpiezas" onclick="filterMarcas('limpiezas')">Limpiezas</button>
      </div>
      <div id="marcas-loading"><div class="spin"></div></div>
      <div id="marcas-empty" class="empty" style="display:none">No tienes marcas asignadas aÃºn.</div>
      <div id="marcas-err"   style="display:none;padding:16px;color:#f87171;font-size:.85rem;text-align:center"></div>
      <div id="marcas-grid"  class="emp-grid" style="display:none"></div>
    </div>

  </div><!-- /main -->
</div><!-- /screen-app -->
<div id="modal-backdrop">
  <div id="modal-box">
    <div class="modal-header">
      <div style="flex:1;min-width:0">
        <p class="mono" style="font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Ficha de cliente</p>
        <h2 id="modal-client-name" style="font-size:1.1rem;font-weight:700;color:var(--hi);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</h2>
        <!-- LÃ­nea compacta: Estado + datos clave separados por | -->
        <div style="display:flex;align-items:center;gap:8px;margin-top:5px;flex-wrap:wrap">
          <span id="modal-estado-pill" class="pill s-pendiente">â€”</span>
          <span id="modal-empresa-lbl" style="font-size:.75rem;color:var(--muted)"></span>
        </div>
        <!-- Subline: TelÃ©fono | Email | PoblaciÃ³n | Marca -->
        <div id="modal-subline"></div>
      </div>
      <button class="modal-close" id="modal-close-btn">âœ•</button>
    </div>

    <div class="modal-tabs">
      <button class="mtab active" data-mpanel="mp-info">InformaciÃ³n</button>
      <button class="mtab" data-mpanel="mp-comments">Comentarios</button>
      <button class="mtab" data-mpanel="mp-docs">Documentos</button>
    </div>

    <div class="modal-body">

      <!-- â”€â”€ Panel: InformaciÃ³n â”€â”€ -->
      <div id="mp-info" class="mpanel active">

        <!-- Bloques destacados: PrÃ³xima AcciÃ³n + Importe -->
        <div class="destaque-row">
          <div class="destaque-card accion">
            <span class="destaque-lbl">ğŸ“… PrÃ³xima AcciÃ³n</span>
            <span class="destaque-val" id="destaque-fecha">â€”</span>
            <span class="destaque-sub" id="destaque-fecha-sub"></span>
            <input id="edit-proxima-accion" type="date" class="info-item-input" style="margin-top:8px"/>
          </div>
          <div class="destaque-card importe">
            <span class="destaque-lbl">ğŸ’¶ Importe Presupuesto</span>
            <span class="destaque-val" id="destaque-importe">â€”</span>
            <span class="destaque-sub">euros</span>
            <input id="edit-importe" type="number" min="0" step="0.01" placeholder="0.00" class="info-item-input" style="margin-top:8px"/>
          </div>
        </div>

        <!-- Selector de estado -->
        <div style="margin-bottom:4px">
          <p class="field-label" style="margin-bottom:8px">Estado del lead</p>
          <div class="estado-selector" id="estado-selector"></div>
        </div>

        <!-- Barra de guardado -->
        <div class="save-bar" id="save-bar">
          <button id="btn-save-info" class="btn-primary" style="font-size:.82rem;padding:9px 20px">Guardar cambios</button>
          <span id="save-ok"  style="font-size:.78rem;color:#4ade80;display:none">âœ“ Guardado</span>
          <span id="save-err" style="font-size:.78rem;color:#f87171;display:none"></span>
        </div>
      </div>

      <!-- â”€â”€ Panel: Comentarios â”€â”€ -->
      <div id="mp-comments" class="mpanel">
        <div id="comments-loading"><div class="spin"></div></div>
        <div id="comments-list" style="display:none"></div>
        <div id="comments-empty" class="empty" style="display:none;padding:16px 0 20px">AÃºn no hay comentarios. Â¡SÃ© el primero!</div>
        <hr style="border:none;border-top:1px solid var(--bd);margin:0 0 16px"/>
        <div class="comment-composer">
          <textarea id="comment-input" placeholder="Escribe un comentarioâ€¦ (Ctrl+Enter para enviar)" rows="2"></textarea>
          <button id="btn-send-comment" class="btn-primary" style="padding:10px 16px;white-space:nowrap">Enviar</button>
        </div>
        <div id="comment-err" class="alert err" style="margin-top:10px"><span id="comment-err-txt"></span></div>
      </div>

      <!-- â”€â”€ Panel: Documentos â”€â”€ -->
      <div id="mp-docs" class="mpanel">
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple/>
          <div class="drop-zone-icon">ğŸ“</div>
          <p><strong>Arrastra archivos aquÃ­</strong> o haz clic para seleccionar</p>
          <p class="drop-zone-hint">PDF, JPG, PNG Â· MÃ¡ximo 5 MB por archivo</p>
        </div>
        <div id="upload-progress-wrap" style="display:none;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span class="spin-sm"></span>
            <span id="upload-progress-label" style="font-size:.78rem;color:var(--muted)">Subiendoâ€¦</span>
          </div>
          <div class="upload-progress"><div id="upload-progress-bar" class="upload-progress-bar" style="width:0%"></div></div>
        </div>
        <div id="docs-err" class="alert err" style="margin-bottom:14px"><span id="docs-err-txt"></span></div>
        <div id="docs-loading"><div class="spin"></div></div>
        <div id="doc-list" class="doc-list" style="display:none"></div>
        <div id="docs-empty" class="empty" style="display:none;padding:12px 0">No hay documentos subidos aÃºn.</div>
      </div>

    </div><!-- /modal-body -->
  </div><!-- /modal-box -->
</div><!-- /modal-backdrop -->

<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(() => {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  CONSTANTES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SB_URL      = 'https://uzmlyawikzqvdoeubrwy.supabase.co';
  const SB_KEY      = 'sb_publishable_-mdEhWbnK-ampAx3EoxrYQ_n7Bu4Dr1';
  const BUCKET      = 'documentos_clientes';
  const MAX_SIZE    = 5 * 1024 * 1024;
  const ALLOWED_EXT = ['.pdf', '.jpg', '.jpeg', '.png'];

  // Estados como strings â€” coinciden con los values del ENUM en Postgres
  // Al llegar al cliente vÃ­a Supabase JS, los ENUMs se representan como strings
  const ESTADOS = [
    'PENDIENTE DE LLAMAR', 'VISITA PROGRAMADA', 'SEGUIMIENTO',
    'PRESUPUESTO ENVIADO', 'OBRA ACEPTADA', 'TRABAJANDO', 'RECHAZADO',
  ];
  const ESTADO_CLS = {
    'PENDIENTE DE LLAMAR': 's-pendiente', 'VISITA PROGRAMADA':   's-visita',
    'SEGUIMIENTO':         's-seguimiento','PRESUPUESTO ENVIADO': 's-presupuesto',
    'OBRA ACEPTADA':       's-aceptada',  'TRABAJANDO':          's-trabajando',
    'RECHAZADO':           's-rechazado',
  };
  const ESTADO_DOT = {
    'PENDIENTE DE LLAMAR': '#f5a623', 'VISITA PROGRAMADA':   '#63a8f8',
    'SEGUIMIENTO':         '#a78bfa', 'PRESUPUESTO ENVIADO': '#fb923c',
    'OBRA ACEPTADA':       '#4ade80', 'TRABAJANDO':          '#2dd4bf',
    'RECHAZADO':           '#f87171',
  };

  const { createClient } = supabase;
  const sb = createClient(SB_URL, SB_KEY);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  ESTADO DE SESIÃ“N
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let rol       = null;    // 'gestor' | 'empresa'
  let userId    = null;    // UUID del registro en gestores o empresas
  let userName  = '';
  // servicios: texto plano de text[] en Postgres â†’ llega como Array<string> en JS
  // Si la columna aÃºn no existe devuelve null; lo normalizamos a []
  let servicios = [];

  let allLeads    = [];
  let marcasMap   = {};
  let empresasMap = {};

  let activeClienteId   = null;
  let activeClienteData = null;
  let pendingEstado     = null;

  let clientesConNuevoComentario = new Set();

  let rtComments = null;
  let rtClientes = null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  HELPERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $          = id => document.getElementById(id);
  const showEl     = (id, m = 'flex') => $(id).style.display = m;
  const hideEl     = id => $(id).style.display = 'none';
  const setAlert   = (id, txtId, msg) => { if (txtId) $(txtId).textContent = msg; $(id).classList.add('show'); };
  const clearAlert = id => $(id).classList.remove('show');

  let toastTimer;
  function toast(msg, type = 'ok') {
    const t = $('toast');
    t.textContent = (type === 'ok' ? 'âœ“ ' : 'âœ• ') + msg;
    t.className = 'toast show ' + type;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.className = 'toast', 3500);
  }

  function esc(s) {
    return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function fmtDate(iso, full = false) {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    if (full) return d.toLocaleString('es-ES', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
    return d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
  }

  function fmtBytes(b) {
    if (b < 1024) return b + ' B';
    if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB';
    return (b / (1024 * 1024)).toFixed(1) + ' MB';
  }

  function docIcon(name) {
    const ext = (name || '').split('.').pop().toLowerCase();
    if (ext === 'pdf') return 'ğŸ“„';
    if (['jpg','jpeg','png'].includes(ext)) return 'ğŸ–¼ï¸';
    return 'ğŸ“';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  SEMÃFORO DE FECHAS
  //  Recibe una fecha 'YYYY-MM-DD' o null.
  //  Devuelve { txt, cls, sub } para mostrar en tabla y modal.
  //  LÃ³gica estilo Asana:
  //    Â· Sin fecha        â†’ gris  'â€”'
  //    Â· Hoy o futura     â†’ verde (fecha + "A tiempo")
  //    Â· Anterior a hoy   â†’ rojo  (fecha + "Atrasado")
  //  ComparaciÃ³n 100 % en local (sin hora): se trunca a 'YYYY-MM-DD'.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function semaforo(valorFecha) {
    if (!valorFecha) return { txt: 'â€”', cls: 'fecha-nil', sub: 'Sin fecha' };

    // Truncar hoy a 'YYYY-MM-DD' para comparaciÃ³n sin zona horaria
    const hoyStr   = new Date().toISOString().slice(0, 10);
    const atrasado = valorFecha < hoyStr;   // comparaciÃ³n lexicogrÃ¡fica vÃ¡lida para ISO

    // Formato legible: 'DD MMM YYYY'
    const [y, m, d] = valorFecha.split('-');
    const legible   = new Date(+y, +m - 1, +d)
      .toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });

    return atrasado
      ? { txt: legible, cls: 'fecha-bad', sub: 'âš  Atrasado' }
      : { txt: legible, cls: 'fecha-ok',  sub: 'âœ“ A tiempo'  };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  TABS PRINCIPALES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      $(btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'tab-dash')   loadDashboard();
      if (btn.dataset.tab === 'tab-marcas') loadMisMarcas();
    });
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  TABS DEL MODAL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.mtab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mtab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.mpanel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      $(btn.dataset.mpanel).classList.add('active');
      if (btn.dataset.mpanel === 'mp-comments' && activeClienteId) loadComments(activeClienteId);
      if (btn.dataset.mpanel === 'mp-docs'     && activeClienteId) loadDocs(activeClienteId);
    });
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  MODAL: ABRIR / CERRAR
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(cliente) {
    activeClienteId   = cliente.id;
    activeClienteData = { ...cliente };
    pendingEstado     = cliente.estado;

    // â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('modal-client-name').textContent = cliente.nombre_cliente || 'Sin nombre';
    $('modal-estado-pill').textContent = cliente.estado || 'â€”';
    $('modal-estado-pill').className   = 'pill ' + (ESTADO_CLS[cliente.estado] || 's-pendiente');
    $('modal-empresa-lbl').textContent = '';  // limpiamos; se rellena tras suscripciÃ³n realtime

    // Subline: TelÃ©fono | Email | PoblaciÃ³n | Marca  (solo los que tienen valor)
    const subItems = [
      cliente.telefono,
      cliente.email,
      cliente.poblacion,
      cliente.marca_id ? (marcasMap[cliente.marca_id] || null) : null,
    ].filter(Boolean);
    $('modal-subline').innerHTML = subItems.map((v, i) =>
      (i > 0 ? '<span class="sep">|</span>' : '') + esc(v)
    ).join('');

    // â”€â”€ Bloque PrÃ³xima AcciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const fechaVal = cliente.fecha_proxima_accion || null;
    const { txt: fechaTxt, cls: fechaCls, sub: fechaSub } = semaforo(fechaVal);
    $('destaque-fecha').textContent     = fechaTxt;
    $('destaque-fecha').className       = 'destaque-val ' + fechaCls;
    $('destaque-fecha-sub').textContent = fechaSub;
    $('edit-proxima-accion').value      = fechaVal || '';

    // â”€â”€ Bloque Importe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const imp = cliente.importe_presupuesto;
    $('destaque-importe').textContent = (imp !== null && imp !== undefined)
      ? Number(imp).toLocaleString('es-ES', { minimumFractionDigits: 2 })
      : 'â€”';
    $('edit-importe').value = (imp !== null && imp !== undefined) ? imp : '';

    // â”€â”€ Selector de estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    renderEstadoSelector(cliente.estado);

    // â”€â”€ Reset save bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('save-bar').classList.remove('visible');
    $('save-ok').style.display  = 'none';
    $('save-err').style.display = 'none';

    // Mostrar save bar al modificar cualquier campo editable
    ['edit-importe', 'edit-proxima-accion'].forEach(id => {
      $(id).addEventListener('input', markDirty, { once: true });
    });

    // â”€â”€ Reset tab â†’ info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.mtab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.mpanel').forEach(p => p.classList.remove('active'));
    document.querySelector('[data-mpanel="mp-info"]').classList.add('active');
    $('mp-info').classList.add('active');
    $('comment-input').value = '';
    clearAlert('comment-err');

    // â”€â”€ Realtime: comentarios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (rtComments) { sb.removeChannel(rtComments); rtComments = null; }
    rtComments = sb
      .channel(`comments:${cliente.id}`)
      .on('postgres_changes', {
        event: 'INSERT', schema: 'public',
        table: 'comentarios_clientes',
        filter: `cliente_id=eq.${cliente.id}`,
      }, payload => {
        if (activeClienteId !== cliente.id) return;
        const commentsActive = document.querySelector('[data-mpanel="mp-comments"]')?.classList.contains('active');
        if (commentsActive) loadComments(activeClienteId);
        else toast(`Nuevo comentario de ${payload.new?.nombre_autor || 'alguien'}`);
      })
      .subscribe(status => {
        if (status === 'SUBSCRIBED') {
          $('modal-empresa-lbl').innerHTML =
            (cliente.empresa_id ? esc(empresasMap[cliente.empresa_id] || '') + ' &nbsp;' : '') +
            '<span class="rt-live">EN VIVO</span>';
        }
      });

    $('modal-backdrop').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    if (rtComments) { sb.removeChannel(rtComments); rtComments = null; }
    $('modal-backdrop').classList.remove('open');
    document.body.style.overflow = '';
    activeClienteId   = null;
    activeClienteData = null;
    pendingEstado     = null;
  }

  function markDirty() { $('save-bar').classList.add('visible'); }

  // â”€â”€ Renderiza los botones de estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderEstadoSelector(estadoActual) {
    const sel = $('estado-selector');
    // estadoActual es string (ENUM value); comparamos con === para evitar coerciÃ³n
    sel.innerHTML = ESTADOS.map(e => {
      const cls  = ESTADO_CLS[e] || '';
      const isSelected = String(e) === String(estadoActual);
      return `<button class="estado-opt${isSelected ? ' selected ' + cls : ''}"
                      data-estado="${esc(e)}">${esc(e)}</button>`;
    }).join('');

    sel.querySelectorAll('.estado-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        const nuevo = btn.dataset.estado;
        if (nuevo === pendingEstado) return;
        pendingEstado = nuevo;
        // Actualizar visual
        sel.querySelectorAll('.estado-opt').forEach(b => {
          b.className = 'estado-opt' + (b.dataset.estado === nuevo ? ' selected ' + (ESTADO_CLS[nuevo] || '') : '');
        });
        markDirty();
      });
    });
  }

  $('modal-close-btn').addEventListener('click', closeModal);
  $('modal-backdrop').addEventListener('click', e => { if (e.target === $('modal-backdrop')) closeModal(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  GUARDAR CAMBIOS DESDE LA FICHA
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('btn-save-info').addEventListener('click', async () => {
    if (!activeClienteId || !activeClienteData) return;
    const btn = $('btn-save-info');
    btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
    $('save-ok').style.display  = 'none';
    $('save-err').style.display = 'none';

    const estadoAnterior = String(activeClienteData.estado);
    const nuevoEstado    = String(pendingEstado);

    // importe_presupuesto: numeric â€” vacÃ­o â†’ null
    const importeRaw = $('edit-importe').value.trim();
    const importeVal = importeRaw !== '' ? parseFloat(importeRaw) : null;

    // fecha_proxima_accion: date 'YYYY-MM-DD' â†’ Postgres acepta directamente; vacÃ­o â†’ null
    const fechaAccionVal = $('edit-proxima-accion').value || null;

    const payload = {
      estado:               nuevoEstado,
      importe_presupuesto:  importeVal,
      fecha_proxima_accion: fechaAccionVal,
    };

    try {
      const { error } = await sb
        .from('clientes')
        .update(payload)
        .eq('id', activeClienteId);

      if (error) throw error;

      // Actualizar cachÃ© local
      activeClienteData = { ...activeClienteData, ...payload };
      const idx = allLeads.findIndex(c => c.id === activeClienteId);
      if (idx !== -1) allLeads[idx] = { ...allLeads[idx], ...payload };

      // Actualizar cabecera del modal
      $('modal-estado-pill').textContent = nuevoEstado;
      $('modal-estado-pill').className   = 'pill ' + (ESTADO_CLS[nuevoEstado] || 's-pendiente');

      // â”€â”€ HISTORIAL DE ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Si el estado cambiÃ³, insertar comentario automÃ¡tico de sistema
      // autor_id = null â†’ no pertenece a ningÃºn usuario â†’ nunca dispara punto rojo
      if (nuevoEstado !== estadoAnterior) {
        const { error: histErr } = await sb.from('comentarios_clientes').insert([{
          cliente_id:   activeClienteId,
          nombre_autor: 'Sistema',
          autor_id:     null,
          texto:        `Sistema: El estado ha cambiado a ${nuevoEstado}`,
          created_at:   new Date().toISOString(),
        }]);
        if (histErr) console.error('Historial de estado:', histErr);
      }

      $('save-ok').style.display = 'inline';
      setTimeout(() => { $('save-ok').style.display = 'none'; }, 3000);
      $('save-bar').classList.remove('visible');
      toast('Cambios guardados correctamente');

      // Refrescar fila de la tabla sin recargar todo
      patchTableRow(activeClienteId, nuevoEstado);

    } catch (err) {
      console.error('Save info:', err);
      $('save-err').textContent  = 'Error: ' + err.message;
      $('save-err').style.display = 'inline';
    } finally {
      btn.disabled = false; btn.textContent = 'Guardar cambios';
    }
  });

  function patchTableRow(id, nuevoEstado) {
    const row = document.querySelector(`#tbl-body tr[data-id="${id}"]`);
    if (!row) return;
    const cls  = ESTADO_CLS[nuevoEstado] || 's-pendiente';
    const cell = row.querySelector('td:nth-child(7)');
    if (cell) cell.innerHTML = `<span class="pill ${cls}">${esc(nuevoEstado)}</span>`;
    row.style.transition = 'background .1s';
    row.style.background = 'rgba(59,125,216,.18)';
    setTimeout(() => { row.style.background = ''; }, 900);
    renderKPIs(allLeads);
    renderEmpresaStats(allLeads);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  LOGIN â€” sin modificaciones (restricciÃ³n)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if (session) await enterApp(session.user);
  }

  $('form-login').addEventListener('submit', async e => {
    e.preventDefault();
    clearAlert('err-login');
    const btn = $('btn-login');
    btn.textContent = 'Verificandoâ€¦'; btn.disabled = true;
    try {
      const { data: auth, error } = await sb.auth.signInWithPassword({
        email: $('l-email').value.trim(), password: $('l-pass').value,
      });
      if (error) throw new Error(error.message);
      await enterApp(auth.user);
    } catch (err) {
      setAlert('err-login', 'err-login-txt', err.message || 'Error al iniciar sesiÃ³n.');
    } finally { btn.textContent = 'Iniciar sesiÃ³n'; btn.disabled = false; }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  DETECCIÃ“N DE ROL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function enterApp(user) {
    // PASO 1 â€” buscar en gestores (.maybeSingle evita error 406 si no hay fila)
    const { data: gestor, error: gErr } = await sb
      .from('gestores')
      .select('id, nombre, servicios')
      .eq('auth_user_id', user.id)
      .maybeSingle();

    if (!gErr && gestor) {
      rol       = 'gestor';
      userId    = gestor.id;
      userName  = gestor.nombre || user.email.split('@')[0];
      servicios = Array.isArray(gestor.servicios) ? gestor.servicios.map(String) : [];
    } else {
      // PASO 2 â€” buscar en empresas (.maybeSingle por consistencia)
      const { data: empresa, error: eErr } = await sb
        .from('empresas')
        .select('id, nombre_comercial, servicios')
        .eq('auth_user_id', user.id)
        .maybeSingle();

      if (eErr || !empresa) throw new Error('No se encontrÃ³ ningÃºn gestor ni empresa para este usuario.');

      rol       = 'empresa';
      userId    = empresa.id;
      userName  = empresa.nombre_comercial || user.email.split('@')[0];
      servicios = Array.isArray(empresa.servicios) ? empresa.servicios.map(String) : [];
    }

    applyRoleUI(user.email);
    // Carga secuencial: empresasMap debe estar completo antes de que
    // cualquier render intente leer nombres de empresa
    await loadEmpresas();
    await loadMarcas();
    fillReformaSelector();

    // â”€â”€ Realtime: cambios en clientes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (rtClientes) { sb.removeChannel(rtClientes); rtClientes = null; }
    const rtFilter = rol === 'gestor'
      ? `gestor_id=eq.${userId}`
      : `empresa_id=eq.${userId}`;

    rtClientes = sb
      .channel(`clientes:${rol}:${userId}`)
      .on('postgres_changes', {
        event: 'UPDATE', schema: 'public', table: 'clientes',
        filter: rtFilter,
      }, payload => {
        const updated = payload.new;
        if (!updated?.id) return;
        const idx = allLeads.findIndex(c => c.id === updated.id);
        if (idx !== -1) {
          allLeads[idx] = { ...allLeads[idx], ...updated };
        } else {
          allLeads.unshift(updated);
        }
        patchTableRow(updated.id, updated.estado);
      })
      .subscribe();

    hideEl('screen-login');
    showEl('screen-app', 'flex');
  }

  function applyRoleUI(email) {
    $('user-display-name').textContent = userName;
    $('user-badge').textContent        = email.split('@')[0];

    if (rol === 'gestor') {
      $('topbar-role-lbl').textContent   = 'Panel Gestor';
      $('gestor-badge-form').textContent = userName;
      $('user-badge').className          = 'badge mono';
      showEl('tab-btn-form',   'block');
      showEl('tab-btn-marcas', 'block');
      $('tab-btn-form').classList.add('active');
      $('tab-btn-dash').classList.remove('active');
      $('tab-btn-marcas').classList.remove('active');
      $('tab-form').classList.add('active');
      $('tab-dash').classList.remove('active');
      $('tab-marcas').classList.remove('active');
      $('stats-card-title').textContent  = 'Rendimiento por Empresa';
    } else {
      $('topbar-role-lbl').textContent   = 'Panel Empresa';
      $('user-badge').className          = 'badge badge-empresa mono';
      hideEl('tab-btn-form');
      hideEl('tab-btn-marcas');
      $('tab-form').classList.remove('active');
      $('tab-marcas').classList.remove('active');
      $('tab-btn-dash').classList.add('active');
      $('tab-dash').classList.add('active');
      $('stats-card-title').textContent  = 'Actividad por Gestor';
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  MAPA SECTOR â†’ SUBSERVICIOS
  //  Sectores son los valores posibles de servicios[] en la DB.
  //  Subservicios son los values del ENUM tipo_reforma en Postgres.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SECTOR_MAP = {
    'REFORMAS':  ['REFORMA INTEGRAL', 'REFORMA DE BAÃ‘O', 'REFORMA DE COCINA'],
    'LIMPIEZAS': ['LIMPIEZA DOMÃ‰STICA', 'FINAL DE OBRA', 'LIMPIEZA DE LOCALES'],
  };

  // Devuelve los sectores que el usuario tiene habilitados
  // (solo los que aparecen en SECTOR_MAP para ignorar valores desconocidos)
  function sectoresDelUsuario() {
    return Object.keys(SECTOR_MAP).filter(s => servicios.includes(s));
  }

  // Devuelve todos los subservicios que el usuario puede ver/registrar
  function subserviciosDelUsuario() {
    return sectoresDelUsuario().flatMap(s => SECTOR_MAP[s]);
  }

  // Inicializa f-sector y f-reforma segÃºn servicios[] del usuario.
  // Si el usuario solo tiene UN sector: lo bloquea y puebla los subservicios directamente.
  // Si tiene VARIOS: muestra el selector de sector y espera elecciÃ³n.
  function fillReformaSelector() {
    const selSector  = $('f-sector');
    const selReforma = $('f-reforma');
    if (!selSector || !selReforma) return;

    const sectores = sectoresDelUsuario();

    // â”€â”€ Poblar selector de sector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    while (selSector.options.length > 1) selSector.remove(1);
    sectores.forEach(s => selSector.add(new Option(s, s)));

    if (sectores.length === 0) {
      // Sin sectores configurados â€” deshabilitar ambos
      selSector.disabled  = true;
      selReforma.disabled = true;
      selReforma.innerHTML = '<option value="">â€” Sin sectores asignados â€”</option>';
      return;
    }

    if (sectores.length === 1) {
      // Un solo sector: bloquearlo y cargar sus subservicios automÃ¡ticamente
      selSector.value    = sectores[0];
      selSector.disabled = true;
      _poblarSubservicios(sectores[0]);
    } else {
      // Varios sectores: selector libre, subservicio espera
      selSector.disabled   = false;
      selSector.value      = '';
      selReforma.disabled  = true;
      selReforma.innerHTML = '<option value="">â€” Elige un sector primero â€”</option>';
    }
  }

  // Puebla f-reforma con los subservicios del sector dado y lo habilita
  function _poblarSubservicios(sector) {
    const selReforma = $('f-reforma');
    if (!selReforma) return;
    const subs = SECTOR_MAP[sector] || [];
    selReforma.innerHTML = '<option value="">â€” Seleccionar subservicio â€”</option>';
    subs.forEach(sub => selReforma.add(new Option(sub, sub)));
    selReforma.disabled = subs.length === 0;
  }

  // Listener: cuando el usuario cambia el sector, actualizar subservicios
  $('f-sector').addEventListener('change', function () {
    if (this.value) {
      _poblarSubservicios(this.value);
    } else {
      const selReforma = $('f-reforma');
      selReforma.innerHTML = '<option value="">â€” Elige un sector primero â€”</option>';
      selReforma.disabled  = true;
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  DROPDOWNS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMarcas() {
    const { data } = await sb.from('marcas').select('id, nombre').order('nombre');
    marcasMap = {};
    const sel = $('f-marca');
    (data || []).forEach(({ id, nombre }) => {
      marcasMap[id] = nombre;
      if (sel) sel.add(new Option(nombre, id));
    });
  }

  async function loadEmpresas() {
    const eRes = await sb.from('empresas').select('*').order('nombre_comercial');

    if (eRes.error) console.error('Error al cargar empresas:', eRes.error);

    // Aviso visual si la tabla no devuelve filas (RLS o tabla vacÃ­a)
    if (!eRes.data || eRes.data.length === 0) {
      const grid = $('marcas-grid');
      if (grid) grid.innerHTML = `<div style="grid-column:1/-1;padding:14px;
        background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);
        border-radius:10px;color:#fca5a5;font-size:.83rem">
        <strong>empresasMap vacÃ­o</strong> â€” la tabla <code>empresas</code> no devolviÃ³ filas.
        Revisa las polÃ­ticas RLS en Supabase para el rol autenticado.
      </div>`;
    }

    empresasMap = {};
    const sel = $('f-empresa');
    (eRes.data || []).forEach(e => {
      console.log('Fila recibida de Supabase:', e);
      const idStr = String(e.id).trim().toLowerCase();
      const nombre = e.nombre_comercial || e.nombre || e.contacto_nombre || 'Sin Nombre';
      empresasMap[idStr] = nombre;
      if (sel) sel.add(new Option(nombre, e.id));
    });

    console.log('Mapa de empresas cargado:', empresasMap);

    if (allLeads.length > 0) renderTable(allLeads);
    if (rol === 'gestor') loadMisMarcas();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  MIS MARCAS (solo gestores)
  //  Flujo en 4 pasos (schema real â€” marcas NO tiene empresa_id):
  //    Paso 1: gestor_marcas  â†’ marca_ids del gestor
  //    Paso 2: marcas         â†’ nombre + descripcion (sector)
  //    Paso 3: empresa_marcas â†’ empresa_id de cada marca (tabla intermedia)
  //    Paso 4: render         â†’ empresasMap[empresa_id] = nombre_comercial (string, en memoria)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMisMarcas() {
    if (rol !== 'gestor') return;

    showEl('marcas-loading', 'block');
    hideEl('marcas-grid');
    hideEl('marcas-empty');
    hideEl('marcas-err');
    $('marcas-grid').innerHTML = '';

    try {
      // â”€â”€ Paso 1: IDs de marcas del gestor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const { data: gm, error: gmErr } = await sb
        .from('gestor_marcas')
        .select('marca_id')
        .eq('gestor_id', userId);

      if (gmErr) throw gmErr;
      if (!gm || gm.length === 0) {
        hideEl('marcas-loading'); showEl('marcas-empty', 'block'); return;
      }
      const marcaIds = gm.map(r => r.marca_id);

      // â”€â”€ Paso 2: datos de las marcas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Solo nombre + descripcion â€” marcas NO tiene columna empresa_id
      const { data: marcas, error: mErr } = await sb
        .from('marcas')
        .select('id, nombre, descripcion')
        .in('id', marcaIds)
        .order('nombre');
      if (mErr) throw mErr;

      // â”€â”€ Paso 3: relaciÃ³n marca â†’ empresa (tabla intermedia) â”€â”€â”€
      // empresa_marcas: { marca_id, empresa_id }
      const { data: em, error: emErr } = await sb
        .from('empresa_marcas')
        .select('marca_id, empresa_id')
        .in('marca_id', marcaIds);
      if (emErr) throw emErr;

      // Construir mapa: marca_id (normalizado) â†’ empresa_id (normalizado)
      const marcaToEmpresaId = {};
      (em || []).forEach(r => {
        const mId = String(r.marca_id).trim().toLowerCase();
        const eId = String(r.empresa_id).trim().toLowerCase();
        marcaToEmpresaId[mId] = eId;
      });

      // â”€â”€ Paso 4: render â€” empresasMap[empresa_id normalizado] â”€â”€
      hideEl('marcas-loading');
      if (!marcas || marcas.length === 0) { showEl('marcas-empty', 'block'); return; }

      function sectorPill(desc) {
        const d = (desc || '').toUpperCase();
        return d.includes('LIMPIEZA')
          ? `<span class="pill s-aceptada">LIMPIEZA</span>`
          : `<span class="pill s-visita">REFORMA</span>`;
      }

      $('marcas-grid').innerHTML = marcas.map(rel => {
        // Normalizar la clave de bÃºsqueda exactamente igual que al escribir el mapa
        const marcaIdNorm  = String(rel.id).trim().toLowerCase();
        const empresaId    = marcaToEmpresaId[marcaIdNorm];
        const empresaIdNorm = empresaId ? String(empresaId).trim().toLowerCase() : null;

        console.log('Marca:', rel.nombre,
                    '| marca_id norm:', marcaIdNorm,
                    '| empresa_id norm:', empresaIdNorm,
                    '| resultado mapa:', empresasMap[empresaIdNorm]);

        // Sin âš  si se encuentra â€” texto de diagnÃ³stico solo cuando falla
        const empresaNombre = empresaIdNorm
          ? (empresasMap[empresaIdNorm] || 'Error: Columna nombre_comercial no existe en los datos recibidos')
          : 'Sin empresa asignada';

        return `
          <div class="marca-card" data-descripcion="${esc(rel.descripcion || '')}">
            <div class="marca-nombre">${esc(rel.nombre)}</div>
            <div>${sectorPill(rel.descripcion)}</div>
            <div class="marca-empresa-row">
              <span class="marca-empresa-lbl">Empresa</span>
              <span class="marca-empresa-val">${esc(empresaNombre)}</span>
            </div>
          </div>`;
      }).join('');

      showEl('marcas-grid', 'grid');
      // Resetear filtro a "Todas" tras cada recarga
      filterMarcas('todas');

    } catch (err) {
      console.error('loadMisMarcas:', err);
      hideEl('marcas-loading');
      $('marcas-err').textContent = 'âœ• Error: ' + (err.message || JSON.stringify(err));
      showEl('marcas-err', 'block');
    }
  }

  // BotÃ³n de refresco manual
  document.addEventListener('DOMContentLoaded', () => {
    const btnR = $('btn-refresh-marcas');
    if (btnR) btnR.addEventListener('click', loadMisMarcas);
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  FILTRO DE SECTOR EN MIS MARCAS
  //  filterMarcas('todas'|'reformas'|'limpiezas')
  //  Lee data-sector de cada .marca-card y oculta/muestra con CSS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function filterMarcas(sector) {
    // Actualizar botones activos
    document.querySelectorAll('#sector-filter .sf-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.sector === sector);
    });

    const cards = document.querySelectorAll('#marcas-grid .marca-card');
    let visible = 0;
    cards.forEach(card => {
      const desc  = (card.dataset.descripcion || '').toUpperCase();
      const match = sector === 'todas'
        || (sector === 'reformas'  && !desc.includes('LIMPIEZA'))
        || (sector === 'limpiezas' && desc.includes('LIMPIEZA'));
      card.style.display = match ? '' : 'none';
      if (match) visible++;
    });

    // Mostrar "vacÃ­o" si ninguna tarjeta pasa el filtro
    const empty = $('marcas-empty');
    if (empty) empty.style.display = visible === 0 ? 'block' : 'none';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  SUBMIT LEAD (solo gestores)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('form-lead').addEventListener('submit', async e => {
    e.preventDefault();
    if (rol !== 'gestor') return;
    clearAlert('form-ok'); clearAlert('form-err');

    const btn = $('btn-lead-submit');
    btn.textContent = 'Guardandoâ€¦'; btn.disabled = true;

    const str = id => { const v = $(id).value.trim(); return v || null; };
    // tipo_reforma: el value del <select> ya es el string del ENUM
    const tipoReforma = str('f-reforma');
    const extra       = $('f-extra').value.trim();

    try {
      // PASO A: insertar cliente y recuperar UUID
      const { data: nuevoCliente, error: clienteErr } = await sb
        .from('clientes')
        .insert([{
          nombre_cliente: str('f-nombre'),
          telefono:       str('f-tel'),
          email:          str('f-email'),
          poblacion:      str('f-pobl'),
          tipo_reforma:   tipoReforma,   // string â†’ Postgres lo castea al ENUM automÃ¡ticamente
          marca_id:       str('f-marca'),
          empresa_id:     str('f-empresa'),
          gestor_id:      userId,
          estado:         'PENDIENTE DE LLAMAR',
        }])
        .select('id')
        .single();

      if (clienteErr) throw clienteErr;
      const clienteId = nuevoCliente.id;

      // PASO B: comentario inicial (solo si hay texto)
      if (extra && clienteId) {
        const { error: cErr } = await sb.from('comentarios_clientes').insert([{
          cliente_id:   clienteId,
          texto:        extra,
          nombre_autor: userName,
          autor_id:     userId,    // UUID del gestor â€” necesario para lÃ³gica de punto rojo
          created_at:   new Date().toISOString(),
        }]);
        if (cErr) {
          console.error('Comentario inicial:', cErr);
          toast('Lead guardado, pero la nota inicial no se pudo registrar.', 'err');
        }
      }

      $('form-lead').reset();
      $('f-extra').value = '';
      fillReformaSelector();   // restaurar opciones tras reset()
      setAlert('form-ok', null, null);
      setTimeout(() => clearAlert('form-ok'), 6000);
      toast('Lead registrado correctamente');
      loadDashboard();

    } catch (err) {
      console.error('Insert cliente:', err);
      setAlert('form-err', 'form-err-txt', 'Error al guardar: ' + (err.message || JSON.stringify(err)));
    } finally {
      btn.textContent = 'Registrar lead'; btn.disabled = false;
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  DASHBOARD
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDashboard() {
    showEl('tbl-loading', 'block'); hideEl('tbl-wrap'); hideEl('tbl-empty');
    $('kpi-row').innerHTML  = '<div class="kpi"><p class="kpi-lbl">Cargandoâ€¦</p></div>';
    $('emp-grid').innerHTML = '<div class="empty">Cargandoâ€¦</div>';
    clientesConNuevoComentario = new Set();

    // â”€â”€ Query de clientes segÃºn rol â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let leadsQuery = sb
      .from('clientes')
      .select('id,nombre_cliente,telefono,email,poblacion,tipo_reforma,marca_id,empresa_id,gestor_id,estado,created_at,updated_at,importe_presupuesto,fecha_proxima_accion')
      .order('created_at', { ascending: false });

    leadsQuery = rol === 'gestor'
      ? leadsQuery.eq('gestor_id', userId)
      : leadsQuery.eq('empresa_id', userId);

    // Traemos autor_id en comentarios para la lÃ³gica de punto rojo
    const [leadsRes, commentsRes] = await Promise.all([
      leadsQuery,
      sb.from('comentarios_clientes')
        .select('cliente_id, created_at, autor_id')
        .order('created_at', { ascending: false }),
    ]);

    hideEl('tbl-loading');

    if (leadsRes.error) {
      console.error('Dashboard:', leadsRes.error);
      $('kpi-row').innerHTML = `<div class="kpi"><p class="kpi-lbl" style="color:#f87171">Error al cargar datos</p></div>`;
      return;
    }

    let leads = leadsRes.data || [];

    // â”€â”€ FILTRO MULTISECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // servicios[] contiene SECTORES (ej: ['REFORMAS', 'LIMPIEZAS']).
    // Necesitamos expandirlos a sus subservicios para comparar con tipo_reforma
    // (que almacena el subservicio concreto, ej: 'REFORMA DE BAÃ‘O').
    //
    // Si el array servicios estÃ¡ vacÃ­o â†’ sin restricciÃ³n, se muestran todos.
    const subserviciosVisibles = subserviciosDelUsuario();
    if (subserviciosVisibles.length > 0) {
      leads = leads.filter(lead => {
        if (!lead.tipo_reforma) return true; // sin tipo â†’ visible siempre
        // tipo_reforma es ENUM â†’ llega como string desde Supabase JS
        return subserviciosVisibles.includes(String(lead.tipo_reforma));
      });
    }

    allLeads = leads;

    // â”€â”€ LÃ“GICA DE NOTIFICACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Punto rojo si: el comentario mÃ¡s reciente tiene autor_id !== userId
    // (es decir, lo escribiÃ³ otra persona)
    // Los comentarios de 'Sistema' tienen autor_id = null â†’ nunca disparan el punto
    const latestByCliente = {};
    (commentsRes.data || []).forEach(c => {
      if (!latestByCliente[c.cliente_id]) latestByCliente[c.cliente_id] = c;
    });

    clientesConNuevoComentario = new Set();
    allLeads.forEach(lead => {
      const last = latestByCliente[lead.id];
      if (!last) return;
      // ComparaciÃ³n: autor_id puede ser UUID o null
      // Si es null (Sistema) â†’ esDeOtro = true pero no queremos mostrar punto
      // Por eso comprobamos tambiÃ©n que autor_id no sea null
      const esDeOtro   = last.autor_id !== null && last.autor_id !== userId;
      const esMasNuevo = new Date(last.created_at) > new Date(lead.updated_at || lead.created_at);
      if (esDeOtro && esMasNuevo) clientesConNuevoComentario.add(lead.id);
    });

    renderKPIs(allLeads);
    renderEmpresaStats(allLeads);
    renderTable(allLeads);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  RENDERS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderKPIs(data) {
    const total    = data.length;
    const ganados  = data.filter(c => ['OBRA ACEPTADA', 'TRABAJANDO'].includes(c.estado)).length;
    const pendient = data.filter(c => c.estado === 'PENDIENTE DE LLAMAR').length;
    const rechaz   = data.filter(c => c.estado === 'RECHAZADO').length;
    const tasa     = total > 0 ? Math.round((ganados / total) * 100) : 0;

    $('kpi-row').innerHTML = [
      { lbl: 'Total Leads',     val: total,      color: '#e6f0ff' },
      { lbl: 'Obras Aceptadas', val: ganados,    color: '#4ade80' },
      { lbl: 'Pendientes',      val: pendient,   color: '#f5a623' },
      { lbl: 'Rechazados',      val: rechaz,     color: '#f87171' },
      { lbl: 'Tasa de Ã‰xito',   val: tasa + '%', color: ganados > 0 ? '#4ade80' : '#3d5a78' },
    ].map(k => `
      <div class="kpi">
        <p class="kpi-lbl">${esc(k.lbl)}</p>
        <p class="kpi-val" style="color:${k.color}">${esc(String(k.val))}</p>
      </div>`).join('');
  }

  function renderEmpresaStats(data) {
    if (!data.length) { $('emp-grid').innerHTML = '<div class="empty">Sin datos.</div>'; return; }

    const groupKey = rol === 'gestor' ? 'empresa_id' : 'gestor_id';
    const getLabel = id => {
      if (!id) return null;
      return rol === 'gestor'
        ? (empresasMap[id] || 'Empresa desconocida')
        : 'Gestor ' + id.slice(0, 8) + 'â€¦';
    };

    const byGroup = {};
    data.forEach(c => {
      const key = c[groupKey] || '__none__';
      if (!byGroup[key]) byGroup[key] = {};
      byGroup[key][c.estado] = (byGroup[key][c.estado] || 0) + 1;
    });

    $('emp-grid').innerHTML = Object.entries(byGroup).map(([gid, counts]) => {
      const label = gid === '__none__'
        ? '<em style="color:var(--muted)">Sin asignar</em>'
        : esc(getLabel(gid));
      const rows = Object.entries(counts).sort((a, b) => b[1] - a[1]).map(([e, n]) => `
        <div class="emp-row">
          <span style="display:flex;align-items:center">
            <span class="estat-dot" style="background:${ESTADO_DOT[e] || '#3d5a78'}"></span>
            <span style="font-size:.74rem;color:var(--txt)">${esc(e)}</span>
          </span>
          <span class="pill ${ESTADO_CLS[e] || ''}">${n}</span>
        </div>`).join('');
      return `<div class="emp-card"><div class="emp-name">${label}</div>${rows}</div>`;
    }).join('');
  }

  function renderTable(data) {
    if (!data.length) { showEl('tbl-empty', 'block'); hideEl('tbl-wrap'); return; }
    hideEl('tbl-empty'); showEl('tbl-wrap', 'block');

    $('tbl-body').innerHTML = data.map(c => {
      const cls      = ESTADO_CLS[c.estado] || 's-pendiente';
      const empNom   = c.empresa_id ? esc(empresasMap[c.empresa_id] || 'â€”') : '<span style="color:var(--muted)">â€”</span>';
      const marcaNom = c.marca_id   ? esc(marcasMap[c.marca_id]     || 'â€”') : '<span style="color:var(--muted)">â€”</span>';
      const hasNew   = clientesConNuevoComentario.has(c.id);
      const notif    = hasNew
        ? '<span class="new-comment-dot">nuevo comentario</span>'
        : '<span class="row-hint">Ver ficha â†’</span>';

      // SemÃ¡foro: usa solo fecha_proxima_accion
      const { txt: fechaTxt, cls: fechaCls } = semaforo(c.fecha_proxima_accion || null);

      return `
        <tr data-id="${esc(c.id)}" title="Clic para abrir la ficha">
          <td style="font-weight:500;color:#dce8f8">${esc(c.nombre_cliente || 'â€”')}</td>
          <td class="mono" style="font-size:.76rem;color:var(--muted)">${esc(c.telefono || 'â€”')}</td>
          <td>${esc(c.poblacion || 'â€”')}</td>
          <td>${c.tipo_reforma
            ? `<span style="font-size:.68rem;background:rgba(255,255,255,.05);border:1px solid var(--bd2);color:var(--txt);padding:2px 8px;border-radius:99px">${esc(String(c.tipo_reforma))}</span>`
            : '<span style="color:var(--muted)">â€”</span>'}</td>
          <td style="font-size:.8rem">${empNom}</td>
          <td style="font-size:.8rem">${marcaNom}</td>
          <td><span class="pill ${cls}">${esc(c.estado || 'â€”')}</span></td>
          <td><span class="${fechaCls}" style="font-size:.78rem;white-space:nowrap">${esc(fechaTxt)}</span></td>
          <td>${notif}</td>
        </tr>`;
    }).join('');

    $('tbl-body').querySelectorAll('tr').forEach(row => {
      row.addEventListener('click', () => {
        const id      = row.dataset.id;
        const cliente = allLeads.find(c => c.id === id);
        if (!cliente) return;
        clientesConNuevoComentario.delete(id);
        const lastTd = row.querySelector('td:last-child');
        if (lastTd) lastTd.innerHTML = '<span class="row-hint">Ver ficha â†’</span>';
        openModal(cliente);
      });
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  COMENTARIOS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadComments(clienteId) {
    showEl('comments-loading', 'block');
    hideEl('comments-list'); hideEl('comments-empty');

    const { data, error } = await sb
      .from('comentarios_clientes')
      .select('id, texto, nombre_autor, autor_id, created_at')
      .eq('cliente_id', clienteId)
      .order('created_at', { ascending: true });

    hideEl('comments-loading');
    if (error) { toast('Error al cargar comentarios: ' + error.message, 'err'); return; }
    if (!data || !data.length) { showEl('comments-empty', 'block'); return; }

    showEl('comments-list', 'flex');
    $('comments-list').style.flexDirection = 'column';
    $('comments-list').innerHTML = data.map(c => {
      const esSistema = c.nombre_autor === 'Sistema';
      return `
        <div class="comment-bubble${esSistema ? ' sistema' : ''}">
          <div class="comment-meta">
            <span class="comment-author${esSistema ? ' sistema' : ''}">${esc(c.nombre_autor || 'Desconocido')}</span>
            <span class="comment-date">${fmtDate(c.created_at, true)}</span>
          </div>
          <div class="comment-text">${esc(c.texto)}</div>
        </div>`;
    }).join('');

    const list = $('comments-list');
    list.scrollTop = list.scrollHeight;
  }

  $('btn-send-comment').addEventListener('click', async () => {
    clearAlert('comment-err');
    const texto = $('comment-input').value.trim();
    if (!texto) { setAlert('comment-err', 'comment-err-txt', 'Escribe algo antes de enviar.'); return; }
    if (!activeClienteId) return;

    const btn = $('btn-send-comment');
    btn.textContent = 'â€¦'; btn.disabled = true;

    try {
      const { error } = await sb.from('comentarios_clientes').insert([{
        cliente_id:   activeClienteId,
        texto,
        nombre_autor: userName,
        autor_id:     userId,   // UUID del usuario actual â€” clave para punto rojo
      }]);
      if (error) throw error;
      $('comment-input').value = '';
      await loadComments(activeClienteId);
      toast('Comentario guardado');
    } catch (err) {
      setAlert('comment-err', 'comment-err-txt', 'Error: ' + (err.message || JSON.stringify(err)));
    } finally { btn.textContent = 'Enviar'; btn.disabled = false; }
  });

  $('comment-input').addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') $('btn-send-comment').click();
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  DOCUMENTOS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDocs(clienteId) {
    showEl('docs-loading', 'block'); hideEl('doc-list'); hideEl('docs-empty');
    clearAlert('docs-err');

    const { data, error } = await sb.storage
      .from(BUCKET)
      .list(clienteId, { sortBy: { column: 'created_at', order: 'desc' } });

    hideEl('docs-loading');
    if (error) { setAlert('docs-err', 'docs-err-txt', 'Error al cargar documentos: ' + error.message); return; }

    const files = (data || []).filter(f => f.name && f.name !== '.emptyFolderPlaceholder');
    if (!files.length) { showEl('docs-empty', 'block'); return; }

    showEl('doc-list', 'flex');
    $('doc-list').style.flexDirection = 'column';
    $('doc-list').innerHTML = files.map(f => `
      <div class="doc-item">
        <span class="doc-icon">${docIcon(f.name)}</span>
        <span class="doc-name" title="${esc(f.name)}">${esc(f.name)}</span>
        <span class="doc-size">${f.metadata?.size ? fmtBytes(f.metadata.size) : ''}</span>
        <button class="btn-sm btn-sm-green"
          onclick="window.__downloadDoc('${esc(clienteId)}','${esc(f.name)}',this)">
          â†“ Descargar
        </button>
      </div>`).join('');
  }

  window.__downloadDoc = async (clienteId, fileName, btn) => {
    btn.textContent = 'â€¦'; btn.disabled = true;
    const { data, error } = await sb.storage.from(BUCKET)
      .createSignedUrl(`${clienteId}/${fileName}`, 60);
    btn.textContent = 'â†“ Descargar'; btn.disabled = false;
    if (error) { toast('Error al generar enlace: ' + error.message, 'err'); return; }
    const a = document.createElement('a');
    a.href = data.signedUrl; a.download = fileName; a.target = '_blank';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  const dz = $('drop-zone');
  const fi = $('file-input');
  dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); handleFiles([...e.dataTransfer.files]); });
  fi.addEventListener('change', () => { handleFiles([...fi.files]); fi.value = ''; });

  async function handleFiles(files) {
    if (!activeClienteId) return;
    clearAlert('docs-err');
    const valid = [];
    for (const f of files) {
      if (f.size > MAX_SIZE) { toast(`${f.name}: supera el lÃ­mite de 5 MB`, 'err'); continue; }
      const ext = '.' + f.name.split('.').pop().toLowerCase();
      if (!ALLOWED_EXT.includes(ext)) { toast(`${f.name}: formato no permitido`, 'err'); continue; }
      valid.push(f);
    }
    if (!valid.length) return;

    const bar = $('upload-progress-bar');
    const lbl = $('upload-progress-label');
    showEl('upload-progress-wrap', 'block');

    for (let i = 0; i < valid.length; i++) {
      const f = valid[i];
      bar.style.width = Math.round((i / valid.length) * 100) + '%';
      lbl.textContent = `Subiendo ${i + 1} de ${valid.length}: ${f.name}`;
      const { error } = await sb.storage.from(BUCKET)
        .upload(`${activeClienteId}/${f.name}`, f, { upsert: true });
      error ? toast(`Error subiendo ${f.name}: ${error.message}`, 'err') : toast(`${f.name} subido`);
    }

    bar.style.width = '100%'; lbl.textContent = 'Completado';
    setTimeout(() => hideEl('upload-progress-wrap'), 1200);
    await loadDocs(activeClienteId);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  REFRESH & LOGOUT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('btn-refresh').addEventListener('click', () => { if (userId) loadDashboard(); });

  $('btn-logout').addEventListener('click', async () => {
    if (rtComments) { sb.removeChannel(rtComments); rtComments = null; }
    if (rtClientes) { sb.removeChannel(rtClientes); rtClientes = null; }
    await sb.auth.signOut();
    rol = null; userId = null; userName = ''; servicios = []; allLeads = [];
    closeModal();
    $('screen-app').style.display = 'none';
    showEl('screen-login', 'flex');
    $('form-login').reset();
    clearAlert('err-login');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    showEl('tab-btn-form', 'block');
    $('tab-btn-form').classList.add('active');
    $('tab-form').classList.add('active');
  });

  sb.auth.onAuthStateChange(ev => {
    if (ev === 'SIGNED_OUT') {
      if (rtComments) { sb.removeChannel(rtComments); rtComments = null; }
      if (rtClientes) { sb.removeChannel(rtClientes); rtClientes = null; }
      rol = null; userId = null; allLeads = [];
      $('screen-app').style.display = 'none';
      showEl('screen-login', 'flex');
    }
  });

  init().catch(err => console.error('Init error:', err));
})();
</script>
</body>
</html>
