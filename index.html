
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Unificado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:    #060911; --s1: #0c1322; --s2: #101929; --s3: #172034;
      --bd:    #1d2e47; --bd2: #27415f; --txt: #c5d5e8; --muted: #3d5a78;
      --hi:    #e6f0ff; --blue: #3b7dd8; --blue2: #5b6ef0;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--txt); min-height: 100vh; }
    h1,h2,h3 { font-family: 'Syne', sans-serif; }
    .mono { font-family: 'DM Mono', monospace; }

    body::before {
      content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background-image: linear-gradient(rgba(59,125,216,.028) 1px,transparent 1px),
                        linear-gradient(90deg,rgba(59,125,216,.028) 1px,transparent 1px);
      background-size: 44px 44px;
    }
    #screen-login, #screen-app { position: relative; z-index: 1; }
    #screen-login { display: flex; }
    #screen-app   { display: none; flex-direction: column; min-height: 100vh; }

    .login-box { background: var(--s2); border: 1px solid var(--bd); border-radius: 18px; padding: 40px 36px; box-shadow: 0 40px 80px rgba(0,0,0,.65), 0 0 0 1px rgba(255,255,255,.025) inset; }
    .accent-bar { height: 3px; background: linear-gradient(90deg, var(--blue), var(--blue2), transparent); border-radius: 18px 18px 0 0; }
    .logo-sq { width: 38px; height: 38px; border-radius: 9px; background: linear-gradient(135deg, var(--blue), var(--blue2)); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(59,125,216,.4); }

    .topbar { background: rgba(6,9,17,.9); border-bottom: 1px solid var(--bd); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 50; }
    .topbar-inner { max-width: 1300px; margin: 0 auto; padding: 0 24px; height: 60px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .tab-bar { display: flex; gap: 3px; background: var(--s1); border: 1px solid var(--bd); border-radius: 10px; padding: 4px; }
    .tab { font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 500; color: var(--muted); background: none; border: none; border-radius: 7px; padding: 7px 18px; cursor: pointer; transition: all .18s; white-space: nowrap; }
    .tab:hover { color: var(--txt); background: rgba(255,255,255,.04); }
    .tab.active { background: var(--s3); color: var(--hi); border: 1px solid var(--bd2); box-shadow: 0 2px 8px rgba(0,0,0,.3); }

    .badge { font-family: 'DM Mono', monospace; font-size: .63rem; background: rgba(59,125,216,.14); border: 1px solid rgba(59,125,216,.28); color: #7eb4f8; padding: 3px 10px; border-radius: 99px; letter-spacing: .05em; }
    .badge-empresa { background: rgba(139,92,246,.14); border-color: rgba(139,92,246,.28); color: #c4b5fd; }
    .btn-ghost { font-family: 'DM Sans', sans-serif; font-size: .75rem; font-weight: 500; background: rgba(255,255,255,.04); border: 1px solid var(--bd); color: var(--muted); border-radius: 8px; padding: 6px 13px; cursor: pointer; transition: color .18s, border-color .18s; }
    .btn-ghost:hover { color: #f87171; border-color: rgba(248,113,113,.3); }

    .main { max-width: 1300px; margin: 0 auto; padding: 28px 24px 52px; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fadein .28s ease both; }
    @keyframes fadein { from { opacity:0; transform:translateY(7px); } to { opacity:1; transform:translateY(0); } }

    .pcard { background: var(--s2); border: 1px solid var(--bd); border-radius: 16px; overflow: hidden; }
    .pcard-head { padding: 18px 22px; border-bottom: 1px solid var(--bd); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .pcard-title { font-family: 'Syne', sans-serif; font-size: .92rem; font-weight: 700; color: var(--hi); }
    .pcard-body { padding: 22px; }

    .field-label { display: block; font-size: .7rem; font-weight: 600; letter-spacing: .09em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .field { width: 100%; background: rgba(255,255,255,.03); border: 1px solid var(--bd); border-radius: 9px; color: var(--txt); font-family: 'DM Sans', sans-serif; font-size: .875rem; padding: 10px 13px; outline: none; transition: border-color .18s, box-shadow .18s; appearance: none; -webkit-appearance: none; }
    .field::placeholder { color: var(--muted); }
    .field:focus { border-color: rgba(59,125,216,.55); box-shadow: 0 0 0 3px rgba(59,125,216,.1); }
    .field option { background: var(--s1); }
    select.field { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233d5a78'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }

    .btn-primary { background: linear-gradient(135deg, var(--blue), var(--blue2)); border: none; border-radius: 9px; color: #fff; font-family: 'DM Sans', sans-serif; font-size: .875rem; font-weight: 600; padding: 11px 24px; cursor: pointer; transition: transform .15s, box-shadow .18s, opacity .18s; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(91,110,240,.4); }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
    .btn-sm { font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 600; border: none; border-radius: 7px; padding: 7px 14px; cursor: pointer; transition: all .15s; }
    .btn-sm-green { background: rgba(34,197,94,.15); color: #4ade80; border: 1px solid rgba(34,197,94,.3); }
    .btn-sm-green:hover { background: rgba(34,197,94,.25); }
    /* Botones modal acciÃ³n */
    .btn-modal-edit   { font-family:'DM Sans',sans-serif; font-size:.74rem; font-weight:600; background:rgba(59,125,216,.1); border:1px solid rgba(59,125,216,.28); color:#7eb4f8; border-radius:7px; padding:5px 12px; cursor:pointer; transition:all .15s; }
    .btn-modal-edit:hover { background:rgba(59,125,216,.2); }
    .btn-modal-del    { font-family:'DM Sans',sans-serif; font-size:.74rem; font-weight:600; background:rgba(239,68,68,.09); border:1px solid rgba(239,68,68,.22); color:#f87171; border-radius:7px; padding:5px 12px; cursor:pointer; transition:all .15s; }
    .btn-modal-del:hover  { background:rgba(239,68,68,.18); }

    .form-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media(max-width:600px) { .form-2col { grid-template-columns: 1fr; } }
    .col-span-2 { grid-column: 1 / -1; }

    .alert { border-radius: 9px; font-size: .83rem; padding: 10px 14px; display: none; }
    .alert.ok  { background: rgba(34,197,94,.1);  border: 1px solid rgba(34,197,94,.3);  color: #86efac; }
    .alert.err { background: rgba(239,68,68,.1);  border: 1px solid rgba(239,68,68,.3);  color: #fca5a5; }
    .alert.show { display: flex; align-items: flex-start; gap: 8px; }

    /* â”€â”€ Filtros â”€â”€ */
    .filtros-bar { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .sf-btn { font-family:'DM Mono',monospace; font-size:.63rem; font-weight:600; letter-spacing:.05em; padding:4px 11px; border-radius:99px; border:1px solid var(--bd); background:rgba(255,255,255,.03); color:var(--muted); cursor:pointer; transition:all .15s; white-space:nowrap; }
    .sf-btn:hover { color:var(--txt); border-color:var(--bd2); }
    .sf-btn.active { background:var(--s3); color:var(--hi); border-color:var(--bd2); }
    .sf-btn.papelera { border-color:rgba(239,68,68,.28); color:#f87171; }
    .sf-btn.papelera.active { background:rgba(239,68,68,.11); border-color:rgba(239,68,68,.45); }
    /* Buscador */
    #search-lead { background:rgba(255,255,255,.03); border:1px solid var(--bd); border-radius:8px; color:var(--txt); font-family:'DM Sans',sans-serif; font-size:.82rem; padding:5px 12px; outline:none; transition:border-color .18s; width:260px; }
    #search-lead::placeholder { color:var(--muted); }
    #search-lead:focus { border-color:rgba(59,125,216,.45); }

    /* â”€â”€ Tel popup â”€â”€ */
    #tel-popup { position:fixed; background:var(--s1); border:1px solid var(--bd2); border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,.55); padding:6px 0; z-index:500; min-width:155px; display:none; }
    #tel-popup.open { display:block; animation:fadein .14s ease both; }
    #tel-popup a { display:flex; align-items:center; gap:9px; padding:9px 14px; font-size:.8rem; color:var(--txt); text-decoration:none; transition:background .12s; }
    #tel-popup a:hover { background:rgba(255,255,255,.06); }

    /* â”€â”€ KPIs â”€â”€ */
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .kpi { background: var(--s3); border: 1px solid var(--bd); border-radius: 14px; padding: 20px 18px; transition: border-color .18s, transform .18s; }
    .kpi:hover { border-color: var(--bd2); transform: translateY(-1px); }
    .kpi-lbl { font-size: .62rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-bottom: 10px; }
    .kpi-val { font-family: 'Syne', sans-serif; font-size: 2.1rem; font-weight: 800; line-height: 1; }

    .emp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .emp-card { background: var(--s3); border: 1px solid var(--bd); border-radius: 13px; padding: 16px 18px; transition: border-color .18s; }
    .emp-card:hover { border-color: var(--bd2); }
    .emp-name { font-family: 'Syne', sans-serif; font-size: .85rem; font-weight: 700; color: var(--hi); margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .emp-row  { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: .78rem; }
    .emp-row:last-child { margin-bottom: 0; }
    .estat-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; display: inline-block; margin-right: 6px; }

    /* â”€â”€ Pills â”€â”€ */
    .pill { font-family: 'DM Mono', monospace; font-size: .63rem; font-weight: 600; letter-spacing: .04em; border-radius: 99px; padding: 3px 9px; border: 1px solid transparent; white-space: nowrap; }
    .s-sin-asignar{ background:rgba(148,163,184,.1);  border-color:rgba(148,163,184,.35); color:#94a3b8; }
    .s-pendiente  { background: rgba(245,166,35,.13); border-color: rgba(245,166,35,.4);  color: #f5a623; }
    .s-visita     { background: rgba(59,125,216,.13);  border-color: rgba(59,125,216,.4);  color: #63a8f8; }
    .s-seguimiento{ background: rgba(139,92,246,.13);  border-color: rgba(139,92,246,.4);  color: #a78bfa; }
    .s-presupuesto{ background: rgba(249,115,22,.13);  border-color: rgba(249,115,22,.4);  color: #fb923c; }
    .s-aceptada   { background: rgba(34,197,94,.13);   border-color: rgba(34,197,94,.4);   color: #4ade80; }
    .s-trabajando { background: rgba(20,184,166,.13);  border-color: rgba(20,184,166,.4);  color: #2dd4bf; }
    .s-rechazado  { background: rgba(239,68,68,.13);   border-color: rgba(239,68,68,.4);   color: #f87171; }
    .s-borrado    { background: rgba(107,114,128,.1);  border-color: rgba(107,114,128,.28);color: #6b7280; }

    /* â”€â”€ Table â”€â”€ */
    .tbl-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    thead th { background: rgba(12,19,34,.98); color: var(--muted); font-size: .65rem; font-weight: 700; text-transform: uppercase; letter-spacing: .09em; padding: 11px 16px; border-bottom: 1px solid var(--bd); text-align: left; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid rgba(29,46,71,.5); transition: background .14s; cursor: pointer; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(59,125,216,.07); }
    tbody td { padding: 11px 16px; font-size: .83rem; vertical-align: middle; }
    .row-hint { font-size: .65rem; color: var(--muted); white-space: nowrap; }
    .btn-row-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:.95rem; padding:2px 5px; border-radius:5px; line-height:1; transition:color .14s; }
    .btn-row-del:hover { color:#f87171; }
    .tel-cell { cursor:pointer; color:var(--muted); font-family:'DM Mono',monospace; font-size:.76rem; text-decoration:underline dotted; text-underline-offset:3px; transition:color .14s; }
    .tel-cell:hover { color:var(--txt); }

    .rt-live { display: inline-flex; align-items: center; gap: 5px; font-family: 'DM Mono', monospace; font-size: .6rem; color: #4ade80; letter-spacing: .06em; }
    .rt-live::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #4ade80; animation: rt-blink 1.8s ease-in-out infinite; }
    @keyframes rt-blink { 0%,100% { opacity: 1; box-shadow: 0 0 4px #4ade80; } 50% { opacity: .4; box-shadow: none; } }

    .new-comment-dot { display: inline-flex; align-items: center; gap: 5px; background: rgba(239,68,68,.13); border: 1px solid rgba(239,68,68,.35); color: #f87171; font-size: .62rem; font-weight: 700; letter-spacing: .04em; padding: 2px 7px; border-radius: 99px; animation: pulse-red 2s ease-in-out infinite; white-space: nowrap; }
    .new-comment-dot::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,.8); }
    @keyframes pulse-red { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } 50% { box-shadow: 0 0 0 3px rgba(239,68,68,.15); } }

    .spin    { width: 20px; height: 20px; border: 2px solid rgba(59,125,216,.2); border-top-color: var(--blue); border-radius: 50%; animation: spin .65s linear infinite; margin: 40px auto; }
    .spin-sm { width: 14px; height: 14px; border: 2px solid rgba(59,125,216,.2); border-top-color: var(--blue); border-radius: 50%; animation: spin .65s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty { padding: 40px 20px; text-align: center; color: var(--muted); font-size: .84rem; }
    .dot-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--blue); flex-shrink: 0; animation: dpulse 2.2s ease-in-out infinite; }
    @keyframes dpulse { 0%,100% { box-shadow: 0 0 6px var(--blue); } 50% { box-shadow: 0 0 16px var(--blue), 0 0 28px rgba(59,125,216,.25); } }
    .sec-divider { border: none; border-top: 1px solid var(--bd); margin: 24px 0; }

    #toast { position: fixed; bottom: 22px; right: 22px; z-index: 200; padding: 10px 16px; border-radius: 10px; font-size: .82rem; font-weight: 500; display: none; align-items: center; gap: 7px; backdrop-filter: blur(12px); box-shadow: 0 8px 24px rgba(0,0,0,.45); }
    #toast.ok  { background: rgba(34,197,94,.14); border: 1px solid rgba(34,197,94,.3); color: #86efac; }
    #toast.err { background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.3); color: #fca5a5; }
    #toast.show { display: flex; }

    /* â”€â”€ Modal â”€â”€ */
    #modal-backdrop { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(4,7,15,.8); backdrop-filter: blur(6px); align-items: flex-start; justify-content: center; padding: 32px 16px; overflow-y: auto; }
    #modal-backdrop.open { display: flex; animation: fadein .22s ease both; }
    #modal-box { background: var(--s1); border: 1px solid var(--bd2); border-radius: 18px; width: 100%; max-width: 780px; box-shadow: 0 40px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.03) inset; overflow: hidden; flex-shrink: 0; animation: modalin .25s cubic-bezier(.16,1,.3,1) both; }
    @keyframes modalin { from { opacity:0; transform:scale(.97) translateY(12px); } to { opacity:1; transform:scale(1) translateY(0); } }
    .modal-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--bd); display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
    .modal-close { background: rgba(255,255,255,.05); border: 1px solid var(--bd); color: var(--muted); border-radius: 7px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; flex-shrink: 0; transition: color .15s, background .15s; }
    .modal-close:hover { background: rgba(248,113,113,.12); color: #f87171; border-color: rgba(248,113,113,.3); }
    .modal-body { padding: 0; }
    .modal-tabs { display: flex; border-bottom: 1px solid var(--bd); background: var(--s2); }
    .mtab { font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 500; color: var(--muted); background: none; border: none; border-bottom: 2px solid transparent; padding: 12px 20px; cursor: pointer; transition: all .18s; white-space: nowrap; margin-bottom: -1px; }
    .mtab:hover { color: var(--txt); }
    .mtab.active { color: var(--hi); border-bottom-color: var(--blue); }
    .mpanel { display: none; padding: 22px 24px; }
    .mpanel.active { display: block; animation: fadein .2s ease both; }

    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    @media(max-width:520px) { .info-grid { grid-template-columns: 1fr; } }
    .info-item { background: var(--s3); border: 1px solid var(--bd); border-radius: 9px; padding: 11px 14px; }
    .info-item-lbl { font-size: .63rem; font-weight: 600; text-transform: uppercase; letter-spacing: .09em; color: var(--muted); margin-bottom: 4px; }
    .info-item-val { font-size: .85rem; color: var(--hi); word-break: break-word; }
    .info-item-input { width: 100%; background: rgba(255,255,255,.04); border: 1px solid var(--bd2); border-radius: 6px; color: var(--hi); font-family: 'DM Sans', sans-serif; font-size: .85rem; padding: 5px 8px; outline: none; transition: border-color .18s; margin-top: 2px; }
    .info-item-input:focus { border-color: rgba(59,125,216,.55); box-shadow: 0 0 0 2px rgba(59,125,216,.1); }
    .info-item-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.6); cursor: pointer; }

    /* â”€â”€ Panel ediciÃ³n datos cliente (gestor) â”€â”€ */
    #edit-panel { display:none; margin-top:14px; padding:16px; background:rgba(255,255,255,.02); border:1px solid var(--bd); border-radius:12px; }
    #edit-panel.open { display:block; animation:fadein .18s ease both; }
    .edit-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:540px){ .edit-grid { grid-template-columns:1fr; } }
    .edit-field { width:100%; background:rgba(255,255,255,.04); border:1px solid var(--bd2); border-radius:7px; color:var(--hi); font-family:'DM Sans',sans-serif; font-size:.84rem; padding:8px 10px; outline:none; transition:border-color .18s; }
    .edit-field:focus { border-color:rgba(59,125,216,.5); }

    .estado-selector { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 14px; }
    .estado-opt { font-family: 'DM Mono', monospace; font-size: .62rem; font-weight: 600; letter-spacing: .04em; border-radius: 99px; padding: 4px 11px; border: 1px solid var(--bd); cursor: pointer; background: rgba(255,255,255,.03); color: var(--muted); transition: all .15s; }
    .estado-opt:hover { color: var(--txt); border-color: var(--bd2); }
    .estado-opt.selected { color: #fff; border-color: transparent; }
    .estado-opt.selected.s-sin-asignar { background: rgba(148,163,184,.4); }
    .estado-opt.selected.s-pendiente   { background: rgba(245,166,35,.55); }
    .estado-opt.selected.s-visita      { background: rgba(59,125,216,.55); }
    .estado-opt.selected.s-seguimiento { background: rgba(139,92,246,.55); }
    .estado-opt.selected.s-presupuesto { background: rgba(249,115,22,.55); }
    .estado-opt.selected.s-aceptada    { background: rgba(34,197,94,.55); }
    .estado-opt.selected.s-trabajando  { background: rgba(20,184,166,.55); }
    .estado-opt.selected.s-rechazado   { background: rgba(239,68,68,.55); }
    .estado-opt.selected.s-borrado     { background: rgba(107,114,128,.4); }

    .save-bar { display: none; align-items: center; gap: 10px; margin-top: 18px; padding-top: 16px; border-top: 1px solid var(--bd); }
    .save-bar.visible { display: flex; }

    #comments-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; max-height: 340px; overflow-y: auto; padding-right: 4px; }
    #comments-list::-webkit-scrollbar { width: 4px; }
    #comments-list::-webkit-scrollbar-track { background: transparent; }
    #comments-list::-webkit-scrollbar-thumb { background: var(--bd2); border-radius: 4px; }
    .comment-bubble { background: var(--s3); border: 1px solid var(--bd); border-radius: 12px; padding: 12px 14px; border-left: 3px solid var(--blue); animation: fadein .2s ease both; }
    .comment-bubble.sistema { border-left-color: #a78bfa; background: rgba(139,92,246,.06); }
    .comment-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; flex-wrap: wrap; }
    .comment-author { font-size: .75rem; font-weight: 600; color: #7eb4f8; }
    .comment-author.sistema { color: #a78bfa; }
    .comment-date   { font-size: .68rem; color: var(--muted); font-family: 'DM Mono', monospace; }
    .comment-text   { font-size: .84rem; color: var(--txt); line-height: 1.55; white-space: pre-wrap; }
    .comment-composer { display: flex; gap: 10px; align-items: flex-end; }
    .comment-composer textarea { flex: 1; min-height: 70px; background: rgba(255,255,255,.03); border: 1px solid var(--bd); border-radius: 9px; color: var(--txt); font-family: 'DM Sans', sans-serif; font-size: .84rem; padding: 10px 12px; outline: none; resize: vertical; transition: border-color .18s; }
    .comment-composer textarea:focus { border-color: rgba(59,125,216,.5); }
    .comment-composer textarea::placeholder { color: var(--muted); }

    .drop-zone { border: 2px dashed var(--bd2); border-radius: 12px; padding: 28px 20px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: border-color .2s, background .2s; position: relative; }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--blue); background: rgba(59,125,216,.06); }
    .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .drop-zone-icon { font-size: 1.6rem; margin-bottom: 8px; }
    .drop-zone p { font-size: .82rem; color: var(--muted); }
    .drop-zone strong { color: var(--txt); }
    .drop-zone-hint { font-size: .7rem; color: var(--muted); margin-top: 5px; }
    .doc-list { display: flex; flex-direction: column; gap: 8px; }
    .doc-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; background: var(--s3); border: 1px solid var(--bd); border-radius: 9px; padding: 10px 13px; }
    .doc-icon { font-size: 1.1rem; flex-shrink: 0; }
    .doc-name { font-size: .82rem; color: var(--txt); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .doc-size { font-size: .7rem; color: var(--muted); font-family: 'DM Mono', monospace; white-space: nowrap; }
    .upload-progress { height: 3px; background: var(--bd); border-radius: 99px; margin-top: 6px; overflow: hidden; }
    .upload-progress-bar { height: 100%; background: linear-gradient(90deg, var(--blue), var(--blue2)); border-radius: 99px; transition: width .3s ease; }

    .fecha-ok  { color: #4ade80; font-weight: 600; }
    .fecha-bad { color: #f87171; font-weight: 600; }
    .fecha-nil { color: var(--muted); }

    .destaque-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
    @media(max-width:480px){ .destaque-row { grid-template-columns: 1fr; } }
    .destaque-card { border-radius: 13px; padding: 16px 18px; border: 1px solid var(--bd2); display: flex; flex-direction: column; gap: 4px; }
    .destaque-card.accion  { background: rgba(59,125,216,.08); border-color: rgba(59,125,216,.3); }
    .destaque-card.importe { background: rgba(34,197,94,.07);  border-color: rgba(34,197,94,.25); }
    .destaque-lbl  { font-size: .6rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); }
    .destaque-val  { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; line-height: 1.15; color: var(--hi); }
    .destaque-sub  { font-size: .72rem; color: var(--muted); margin-top: 2px; }

    #modal-subline { font-size: .75rem; color: var(--muted); margin-top: 5px; display: flex; flex-wrap: wrap; gap: 0; align-items: center; }
    #modal-subline .sep { margin: 0 6px; opacity: .35; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="items-center justify-center min-h-screen px-4 py-12">
  <div class="w-full max-w-[410px]">
    <div class="login-box">
      <div class="accent-bar" style="margin:-40px -36px 32px;border-radius:18px 18px 0 0"></div>
      <div style="display:flex;align-items:center;gap:13px;margin-bottom:28px">
        <div class="logo-sq">
          <svg width="18" height="18" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div>
          <p class="mono" style="font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted)">Red Comercial</p>
          <h1 style="font-size:1.15rem;color:var(--hi)">Panel de Acceso</h1>
        </div>
      </div>
      <div id="err-login" class="alert err" style="margin-bottom:16px">
        <svg style="width:14px;height:14px;flex-shrink:0;margin-top:1px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span id="err-login-txt"></span>
      </div>
      <form id="form-login" novalidate>
        <div style="margin-bottom:14px">
          <label class="field-label" for="l-email">Email</label>
          <input id="l-email" type="email" required placeholder="usuario@email.com" class="field"/>
        </div>
        <div style="margin-bottom:22px">
          <label class="field-label" for="l-pass">ContraseÃ±a</label>
          <input id="l-pass" type="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="field"/>
        </div>
        <button id="btn-login" type="submit" class="btn-primary" style="width:100%">Iniciar sesiÃ³n</button>
      </form>
    </div>
    <p style="text-align:center;font-size:.72rem;color:var(--muted);margin-top:18px">Acceso exclusivo Â· Gestores y Empresas autorizadas</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-app">
  <nav class="topbar">
    <div style="height:2px;background:linear-gradient(90deg,var(--blue),var(--blue2),transparent)"></div>
    <div class="topbar-inner">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div class="dot-pulse"></div>
        <div>
          <p id="topbar-role-lbl" class="mono" style="font-size:.57rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)">Panel</p>
          <p id="user-display-name" style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:var(--hi);line-height:1.2">Cargandoâ€¦</p>
        </div>
        <div style="width:1px;height:20px;background:var(--bd);margin:0 4px"></div>
        <div class="tab-bar">
          <button id="tab-btn-form" class="tab" data-tab="tab-form" style="display:none"><span style="margin-right:5px">âœ¦</span>Registrar Lead</button>
          <button id="tab-btn-dash" class="tab" data-tab="tab-dash"><span style="margin-right:5px">â—ˆ</span>Dashboard</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="user-badge" class="badge mono"></span>
        <button id="btn-logout" class="btn-ghost">Salir</button>
      </div>
    </div>
  </nav>

  <div class="main">

    <!-- â•â• TAB 1: FORMULARIO (solo gestores) â•â• -->
    <div id="tab-form" class="tab-panel">
      <div class="pcard" style="max-width:720px;margin:0 auto">
        <div class="pcard-head">
          <div>
            <div class="pcard-title">Alta de Nuevo Lead</div>
            <p style="font-size:.76rem;color:var(--muted);margin-top:3px">Todos los campos son opcionales</p>
          </div>
          <span class="badge mono" id="gestor-badge-form"></span>
        </div>
        <div class="pcard-body">
          <div id="form-ok" class="alert ok" style="margin-bottom:18px">
            <svg style="width:14px;height:14px;flex-shrink:0;margin-top:1px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            <span>Lead registrado correctamente. Formulario listo para el siguiente.</span>
          </div>
          <div id="form-err" class="alert err" style="margin-bottom:18px">
            <svg style="width:14px;height:14px;flex-shrink:0;margin-top:1px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span id="form-err-txt"></span>
          </div>
          <form id="form-lead" novalidate>
            <div class="form-2col">
              <div><label class="field-label" for="f-nombre">Nombre cliente</label><input id="f-nombre" type="text" placeholder="Ej: Carmen Rivas" class="field"/></div>
              <div><label class="field-label" for="f-tel">TelÃ©fono</label><input id="f-tel" type="text" placeholder="6XX XXX XXX" class="field"/></div>
              <div><label class="field-label" for="f-email">Email</label><input id="f-email" type="email" placeholder="cliente@email.com" class="field"/></div>
              <div><label class="field-label" for="f-pobl">PoblaciÃ³n</label><input id="f-pobl" type="text" placeholder="Ciudad o municipio" class="field"/></div>
              <div>
                <label class="field-label" for="f-sector">Sector</label>
                <select id="f-sector" class="field"><option value="">â€” Seleccionar â€”</option></select>
              </div>
              <div>
                <label class="field-label" for="f-reforma">Subservicio</label>
                <select id="f-reforma" class="field" disabled><option value="">â€” Elige un sector primero â€”</option></select>
              </div>
              <div><label class="field-label" for="f-marca">Marca</label><select id="f-marca" class="field"><option value="">â€” Seleccionar â€”</option></select></div>
              <div class="col-span-2"><label class="field-label" for="f-empresa">Empresa</label><select id="f-empresa" class="field"><option value="">â€” Seleccionar â€”</option></select></div>
            </div>
            <div style="margin-top:16px">
              <label class="field-label" for="f-extra">
                InformaciÃ³n extra para la empresa
                <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted);margin-left:6px">(opcional Â· se guardarÃ¡ como nota interna)</span>
              </label>
              <textarea id="f-extra" rows="3"
                placeholder="Escribe aquÃ­ cualquier detalle adicional que deba ver la empresaâ€¦"
                style="width:100%;background:rgba(255,255,255,.03);border:1px solid var(--bd);border-radius:9px;color:var(--txt);font-family:'DM Sans',sans-serif;font-size:.875rem;padding:10px 13px;outline:none;resize:vertical;transition:border-color .18s,box-shadow .18s;"
                onfocus="this.style.borderColor='rgba(59,125,216,.55)';this.style.boxShadow='0 0 0 3px rgba(59,125,216,.1)'"
                onblur="this.style.borderColor='';this.style.boxShadow=''"></textarea>
            </div>
            <hr class="sec-divider"/>
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
              <p style="font-size:.75rem;color:var(--muted)">Estado inicial: <span id="estado-inicial-lbl" class="pill s-sin-asignar" style="margin-left:4px">PENDIENTE DE ASIGNAR</span></p>
              <button id="btn-lead-submit" type="submit" class="btn-primary">Registrar lead</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- â•â• TAB 2: DASHBOARD â•â• -->
    <div id="tab-dash" class="tab-panel">
      <div style="display:flex;justify-content:flex-end;margin-bottom:18px">
        <button id="btn-refresh" class="btn-ghost">â†» Actualizar datos</button>
      </div>

      <!-- KPIs: solo gestor -->
      <div id="kpi-wrap" style="display:none">
        <div id="kpi-row" class="kpi-row"><div class="kpi"><p class="kpi-lbl">Cargandoâ€¦</p></div></div>
      </div>

      <!-- Stats card: solo gestor -->
      <div id="stats-wrap" class="pcard" style="margin-bottom:24px;display:none">
        <div class="pcard-head">
          <div class="pcard-title" id="stats-card-title">Rendimiento por Empresa</div>
          <span style="font-size:.72rem;color:var(--muted)">DistribuciÃ³n de estados</span>
        </div>
        <div class="pcard-body"><div id="emp-grid" class="emp-grid"><div class="empty">Cargandoâ€¦</div></div></div>
      </div>

      <!-- Filtros + buscador -->
      <div style="margin-bottom:14px;display:flex;flex-direction:column;gap:8px">
        <!-- Fila estados + papelera -->
        <div class="filtros-bar" id="filtros-estado-row"></div>
        <!-- Fila sector (gestor) + buscador -->
        <div style="display:flex;flex-wrap:wrap;align-items:center;gap:8px">
          <div class="filtros-bar" id="filtros-sector-row" style="flex:1;min-width:0"></div>
          <input id="search-lead" type="text" placeholder="Buscar: nombre, tel, poblaciÃ³n, marcaâ€¦"/>
        </div>
      </div>

      <div class="pcard">
        <div class="pcard-head">
          <div class="pcard-title">Seguimiento de Leads</div>
          <span style="font-size:.72rem;color:var(--muted)">Haz clic en una fila para abrir la ficha</span>
        </div>
        <div id="tbl-loading"><div class="spin"></div></div>
        <div id="tbl-empty" class="empty" style="display:none">No hay leads registrados.</div>
        <div id="tbl-wrap" class="tbl-wrap" style="display:none">
          <table id="leads-table">
            <thead>
              <tr id="tbl-head">
                <th>Cliente</th><th>TelÃ©fono</th><th>PoblaciÃ³n</th>
                <th>Fecha entrada</th><th class="th-empresa">Empresa</th><th>Marca</th>
                <th>Estado</th><th>PrÃ³xima AcciÃ³n</th><th></th><th class="th-acciones"></th>
              </tr>
            </thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-backdrop">
  <div id="modal-box">
    <div class="modal-header">
      <div style="flex:1;min-width:0">
        <p class="mono" style="font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Ficha de cliente</p>
        <h2 id="modal-client-name" style="font-size:1.1rem;font-weight:700;color:var(--hi);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</h2>
        <div style="display:flex;align-items:center;gap:8px;margin-top:5px;flex-wrap:wrap">
          <span id="modal-estado-pill" class="pill s-pendiente">â€”</span>
          <span id="modal-empresa-lbl" style="font-size:.75rem;color:var(--muted)"></span>
        </div>
        <div id="modal-subline"></div>
      </div>
      <!-- Acciones gestor -->
      <div style="display:flex;gap:6px;align-items:flex-start;flex-shrink:0">
        <button id="btn-modal-edit" class="btn-modal-edit" style="display:none">âœŽ Editar</button>
        <button id="btn-modal-del"  class="btn-modal-del"  style="display:none">ðŸ—‘</button>
        <button class="modal-close" id="modal-close-btn">âœ•</button>
      </div>
    </div>

    <div class="modal-tabs">
      <button class="mtab active" data-mpanel="mp-info">InformaciÃ³n</button>
      <button class="mtab" data-mpanel="mp-comments">Comentarios</button>
      <button class="mtab" data-mpanel="mp-docs">Documentos</button>
    </div>

    <div class="modal-body">

      <!-- â”€â”€ Panel: InformaciÃ³n â”€â”€ -->
      <div id="mp-info" class="mpanel active">

        <div class="destaque-row">
          <div class="destaque-card accion">
            <span class="destaque-lbl">ðŸ“… PrÃ³xima AcciÃ³n</span>
            <span class="destaque-val" id="destaque-fecha">â€”</span>
            <span class="destaque-sub" id="destaque-fecha-sub"></span>
            <input id="edit-proxima-accion" type="date" class="info-item-input" style="margin-top:8px"/>
          </div>
          <div class="destaque-card importe">
            <span class="destaque-lbl">ðŸ’¶ Importe Presupuesto</span>
            <span class="destaque-val" id="destaque-importe">â€”</span>
            <span class="destaque-sub">euros</span>
            <input id="edit-importe" type="number" min="0" step="0.01" placeholder="0.00" class="info-item-input" style="margin-top:8px"/>
          </div>
        </div>

        <!-- Panel ediciÃ³n datos cliente (solo gestor, toggle) -->
        <div id="edit-panel">
          <p style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:10px">âœŽ Datos del cliente</p>
          <div class="edit-grid">
            <div>
              <label class="field-label" style="font-size:.6rem">Nombre</label>
              <input id="edit-nombre" type="text" class="edit-field" placeholder="Nombre cliente"/>
            </div>
            <div>
              <label class="field-label" style="font-size:.6rem">TelÃ©fono</label>
              <input id="edit-tel" type="text" class="edit-field" placeholder="6XX XXX XXX"/>
            </div>
            <div>
              <label class="field-label" style="font-size:.6rem">Email</label>
              <input id="edit-email" type="email" class="edit-field" placeholder="email@ejemplo.com"/>
            </div>
            <div>
              <label class="field-label" style="font-size:.6rem">PoblaciÃ³n</label>
              <input id="edit-pobl" type="text" class="edit-field" placeholder="Ciudad"/>
            </div>
          </div>
        </div>

        <div style="margin-top:16px;margin-bottom:4px">
          <p class="field-label" style="margin-bottom:8px">Estado del lead</p>
          <div class="estado-selector" id="estado-selector"></div>
        </div>

        <div class="save-bar" id="save-bar">
          <button id="btn-save-info" class="btn-primary" style="font-size:.82rem;padding:9px 20px">Guardar cambios</button>
          <span id="save-ok"  style="font-size:.78rem;color:#4ade80;display:none">âœ“ Guardado</span>
          <span id="save-err" style="font-size:.78rem;color:#f87171;display:none"></span>
        </div>
      </div>

      <!-- â”€â”€ Panel: Comentarios â”€â”€ -->
      <div id="mp-comments" class="mpanel">
        <div id="comments-loading"><div class="spin"></div></div>
        <div id="comments-list" style="display:none"></div>
        <div id="comments-empty" class="empty" style="display:none;padding:16px 0 20px">AÃºn no hay comentarios. Â¡SÃ© el primero!</div>
        <hr style="border:none;border-top:1px solid var(--bd);margin:0 0 16px"/>
        <div class="comment-composer">
          <textarea id="comment-input" placeholder="Escribe un comentarioâ€¦ (Ctrl+Enter para enviar)" rows="2"></textarea>
          <button id="btn-send-comment" class="btn-primary" style="padding:10px 16px;white-space:nowrap">Enviar</button>
        </div>
        <div id="comment-err" class="alert err" style="margin-top:10px"><span id="comment-err-txt"></span></div>
      </div>

      <!-- â”€â”€ Panel: Documentos â”€â”€ -->
      <div id="mp-docs" class="mpanel">
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple/>
          <div class="drop-zone-icon">ðŸ“Ž</div>
          <p><strong>Arrastra archivos aquÃ­</strong> o haz clic para seleccionar</p>
          <p class="drop-zone-hint">PDF, JPG, PNG Â· MÃ¡ximo 5 MB por archivo</p>
        </div>
        <div id="upload-progress-wrap" style="display:none;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span class="spin-sm"></span>
            <span id="upload-progress-label" style="font-size:.78rem;color:var(--muted)">Subiendoâ€¦</span>
          </div>
          <div class="upload-progress"><div id="upload-progress-bar" class="upload-progress-bar" style="width:0%"></div></div>
        </div>
        <div id="docs-err" class="alert err" style="margin-bottom:14px"><span id="docs-err-txt"></span></div>
        <div id="docs-loading"><div class="spin"></div></div>
        <div id="doc-list" class="doc-list" style="display:none"></div>
        <div id="docs-empty" class="empty" style="display:none;padding:12px 0">No hay documentos subidos aÃºn.</div>
      </div>

    </div><!-- /modal-body -->
  </div><!-- /modal-box -->
</div><!-- /modal-backdrop -->

<!-- Popup telÃ©fono -->
<div id="tel-popup">
  <a id="tel-call" href="#"><span>ðŸ“ž</span> Llamar</a>
  <a id="tel-wa"   href="#" target="_blank" rel="noopener"><span>ðŸ’¬</span> WhatsApp</a>
</div>

<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(() => {
  // â”€â”€â”€ CONSTANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SB_URL      = 'https://uzmlyawikzqvdoeubrwy.supabase.co';
  const SB_KEY      = 'sb_publishable_-mdEhWbnK-ampAx3EoxrYQ_n7Bu4Dr1';
  const BUCKET      = 'documentos_clientes';
  const MAX_SIZE    = 5 * 1024 * 1024;
  const ALLOWED_EXT = ['.pdf', '.jpg', '.jpeg', '.png'];

  const ESTADOS = [
    'PENDIENTE DE ASIGNAR',
    'PENDIENTE DE LLAMAR', 'VISITA PROGRAMADA', 'SEGUIMIENTO',
    'PRESUPUESTO ENVIADO', 'OBRA ACEPTADA', 'TRABAJANDO', 'RECHAZADO',
    'BORRADO',
  ];
  const ESTADO_CLS = {
    'PENDIENTE DE ASIGNAR':  's-sin-asignar',
    'PENDIENTE DE LLAMAR':   's-pendiente',  'VISITA PROGRAMADA':   's-visita',
    'SEGUIMIENTO':           's-seguimiento','PRESUPUESTO ENVIADO':  's-presupuesto',
    'OBRA ACEPTADA':         's-aceptada',   'TRABAJANDO':          's-trabajando',
    'RECHAZADO':             's-rechazado',  'BORRADO':             's-borrado',
  };
  const ESTADO_DOT = {
    'PENDIENTE DE ASIGNAR':  '#94a3b8',
    'PENDIENTE DE LLAMAR':   '#f5a623', 'VISITA PROGRAMADA':   '#63a8f8',
    'SEGUIMIENTO':           '#a78bfa', 'PRESUPUESTO ENVIADO': '#fb923c',
    'OBRA ACEPTADA':         '#4ade80', 'TRABAJANDO':          '#2dd4bf',
    'RECHAZADO':             '#f87171', 'BORRADO':             '#6b7280',
  };
  const SECTOR_MAP = {
    'REFORMAS':  ['REFORMA INTEGRAL', 'REFORMA DE BAÃ‘O', 'REFORMA DE COCINA'],
    'LIMPIEZAS': ['LIMPIEZA DOMÃ‰STICA', 'FINAL DE OBRA', 'LIMPIEZA DE LOCALES'],
  };

  const { createClient } = supabase;
  const sb = createClient(SB_URL, SB_KEY);

  // â”€â”€â”€ SESIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let rol = null, userId = null, userName = '', servicios = [];
  let allLeads = [], marcasMap = {}, empresasMap = {};
  let activeClienteId = null, activeClienteData = null, pendingEstado = null;
  let clientesConNuevoComentario = new Set();
  let rtComments = null, rtClientes = null;

  // â”€â”€â”€ FILTROS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let filtroEstado = null, filtroSector = null, filtroPapelera = false, filtroBusqueda = '';

  // â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $      = id => document.getElementById(id);
  const showEl = (id, m='flex') => { const e=$(id); if(e) e.style.display=m; };
  const hideEl = id => { const e=$(id); if(e) e.style.display='none'; };
  const setAlert   = (id,t,m) => { if(t) $(t).textContent=m; $(id).classList.add('show'); };
  const clearAlert = id => $(id).classList.remove('show');

  let toastTimer;
  function toast(msg, type='ok') {
    const t=$('toast'); t.textContent=(type==='ok'?'âœ“ ':'âœ• ')+msg; t.className='toast show '+type;
    clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.className='toast',3500);
  }
  function esc(s) { return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function fmtDate(iso, full=false) {
    if(!iso) return 'â€”';
    const d=new Date(iso);
    if(full) return d.toLocaleString('es-ES',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    return d.toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'numeric'});
  }
  function fmtBytes(b) {
    if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB';
    return (b/1048576).toFixed(1)+' MB';
  }
  function docIcon(n) { const e=(n||'').split('.').pop().toLowerCase(); return e==='pdf'?'ðŸ“„':['jpg','jpeg','png'].includes(e)?'ðŸ–¼ï¸':'ðŸ“Ž'; }

  function semaforo(v) {
    if(!v) return {txt:'â€”',cls:'fecha-nil',sub:'Sin fecha'};
    const h=new Date().toISOString().slice(0,10), atrasado=v<h;
    const [y,m,d]=v.split('-');
    const leg=new Date(+y,+m-1,+d).toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'numeric'});
    return atrasado?{txt:leg,cls:'fecha-bad',sub:'âš  Atrasado'}:{txt:leg,cls:'fecha-ok',sub:'âœ“ A tiempo'};
  }

  // ResoluciÃ³n de marca con normalizaciÃ³n de ID
  function getMarcaNombre(marcaId) {
    if(!marcaId) return '';
    if(marcasMap[marcaId]) return marcasMap[marcaId];
    const norm=String(marcaId).trim().toLowerCase();
    for(const [k,v] of Object.entries(marcasMap)) { if(String(k).trim().toLowerCase()===norm) return v; }
    return '';
  }

  // Sector de un tipo_reforma
  function sectorDeReforma(tipo) {
    if(!tipo) return null;
    const t=String(tipo).toUpperCase();
    for(const [s,subs] of Object.entries(SECTOR_MAP)) { if(subs.includes(t)) return s; }
    return null;
  }

  // â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      $(btn.dataset.tab).classList.add('active');
      if(btn.dataset.tab==='tab-dash') loadDashboard();
    });
  });
  document.querySelectorAll('.mtab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.mpanel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      $(btn.dataset.mpanel).classList.add('active');
      if(btn.dataset.mpanel==='mp-comments' && activeClienteId) loadComments(activeClienteId);
      if(btn.dataset.mpanel==='mp-docs'     && activeClienteId) loadDocs(activeClienteId);
    });
  });

  // â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(cliente) {
    activeClienteId=cliente.id; activeClienteData={...cliente}; pendingEstado=cliente.estado;

    $('modal-client-name').textContent = cliente.nombre_cliente||'Sin nombre';
    $('modal-estado-pill').textContent = cliente.estado||'â€”';
    $('modal-estado-pill').className   = 'pill '+(ESTADO_CLS[cliente.estado]||'s-pendiente');
    $('modal-empresa-lbl').textContent = '';

    // Subline: Tel | Email | PoblaciÃ³n | Marca
    const marcaNomModal = getMarcaNombre(cliente.marca_id);
    const subItems=[cliente.telefono,cliente.email,cliente.poblacion,marcaNomModal||null].filter(Boolean);
    $('modal-subline').innerHTML=subItems.map((v,i)=>(i>0?'<span class="sep">|</span>':'')+esc(v)).join('');

    // PrÃ³xima acciÃ³n
    const fv=cliente.fecha_proxima_accion||null, {txt,cls:fc,sub}=semaforo(fv);
    $('destaque-fecha').textContent=txt; $('destaque-fecha').className='destaque-val '+fc;
    $('destaque-fecha-sub').textContent=sub; $('edit-proxima-accion').value=fv||'';

    // Importe
    const imp=cliente.importe_presupuesto;
    $('destaque-importe').textContent=(imp!==null&&imp!==undefined)?Number(imp).toLocaleString('es-ES',{minimumFractionDigits:2}):'â€”';
    $('edit-importe').value=(imp!==null&&imp!==undefined)?imp:'';

    // Selector de estado
    renderEstadoSelector(cliente.estado);

    // Panel ediciÃ³n (solo gestor)
    $('edit-panel').classList.remove('open');
    if(rol==='gestor') {
      $('btn-modal-edit').style.display='';
      $('btn-modal-del').style.display='';
      $('edit-nombre').value=cliente.nombre_cliente||'';
      $('edit-tel').value=cliente.telefono||'';
      $('edit-email').value=cliente.email||'';
      $('edit-pobl').value=cliente.poblacion||'';
    } else {
      $('btn-modal-edit').style.display='none';
      $('btn-modal-del').style.display='none';
    }

    // Empresa rol empresa: solo lectura del selector de estado
    if(rol==='empresa') {
      $('estado-selector').querySelectorAll('.estado-opt').forEach(b=>{ b.style.pointerEvents='none'; b.style.opacity='.45'; });
    }

    // Save bar
    $('save-bar').classList.remove('visible');
    $('save-ok').style.display='none'; $('save-err').style.display='none';
    ['edit-importe','edit-proxima-accion'].forEach(id=>$(id).addEventListener('input',markDirty,{once:true}));

    // Reset tabs â†’ info
    document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.mpanel').forEach(p=>p.classList.remove('active'));
    document.querySelector('[data-mpanel="mp-info"]').classList.add('active');
    $('mp-info').classList.add('active');
    $('comment-input').value=''; clearAlert('comment-err');

    // Realtime comentarios
    if(rtComments) { sb.removeChannel(rtComments); rtComments=null; }
    rtComments=sb.channel(`comments:${cliente.id}`)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'comentarios_clientes',filter:`cliente_id=eq.${cliente.id}`},payload=>{
        if(activeClienteId!==cliente.id) return;
        const active=document.querySelector('[data-mpanel="mp-comments"]')?.classList.contains('active');
        if(active) loadComments(activeClienteId);
        else toast(`Nuevo comentario de ${payload.new?.nombre_autor||'alguien'}`);
      })
      .subscribe(s=>{
        if(s==='SUBSCRIBED') {
          $('modal-empresa-lbl').innerHTML=(cliente.empresa_id?esc(empresasMap[cliente.empresa_id]||'')+' &nbsp;':'')+'<span class="rt-live">EN VIVO</span>';
        }
      });

    $('modal-backdrop').classList.add('open');
    document.body.style.overflow='hidden';
  }

  function closeModal() {
    if(rtComments) { sb.removeChannel(rtComments); rtComments=null; }
    $('modal-backdrop').classList.remove('open');
    document.body.style.overflow='';
    activeClienteId=null; activeClienteData=null; pendingEstado=null;
  }
  function markDirty() { $('save-bar').classList.add('visible'); }

  // â”€â”€ BotÃ³n Editar (toggle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('btn-modal-edit').addEventListener('click', () => {
    $('edit-panel').classList.toggle('open');
    if($('edit-panel').classList.contains('open')) markDirty();
  });

  // â”€â”€ BotÃ³n Eliminar modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('btn-modal-del').addEventListener('click', async () => {
    if(!activeClienteId || rol!=='gestor') return;
    const motivo=prompt('Motivo de borrado (obligatorio):');
    if(motivo===null || !motivo.trim()) { toast('Borrado cancelado: motivo obligatorio','err'); return; }
    await softDeleteLead(activeClienteId, motivo.trim());
  });

  // â”€â”€ Selector de estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderEstadoSelector(estadoActual) {
    const sel=$('estado-selector');
    const visibles=rol==='gestor'
      ? ESTADOS.filter(e=>e!=='BORRADO')
      : ESTADOS.filter(e=>!['BORRADO','PENDIENTE DE ASIGNAR'].includes(e));

    sel.innerHTML=visibles.map(e=>{
      const cls=ESTADO_CLS[e]||'';
      const isSel=String(e)===String(estadoActual);
      return `<button class="estado-opt${isSel?' selected '+cls:''}" data-estado="${esc(e)}">${esc(e)}</button>`;
    }).join('');

    if(rol==='gestor') {
      sel.querySelectorAll('.estado-opt').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const nuevo=btn.dataset.estado;
          if(nuevo===pendingEstado) return;
          pendingEstado=nuevo;
          sel.querySelectorAll('.estado-opt').forEach(b=>{
            b.className='estado-opt'+(b.dataset.estado===nuevo?' selected '+(ESTADO_CLS[nuevo]||''):'');
          });
          markDirty();
        });
      });
    }
  }

  $('modal-close-btn').addEventListener('click', closeModal);
  $('modal-backdrop').addEventListener('click', e=>{ if(e.target===$('modal-backdrop')) closeModal(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  // â”€â”€â”€ GUARDAR CAMBIOS (solo gestor) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('btn-save-info').addEventListener('click', async () => {
    if(!activeClienteId || !activeClienteData || rol!=='gestor') return;
    const btn=$('btn-save-info');
    btn.disabled=true; btn.textContent='Guardandoâ€¦';
    $('save-ok').style.display='none'; $('save-err').style.display='none';

    const estadoAnterior=String(activeClienteData.estado);
    const nuevoEstado=String(pendingEstado);
    const importeRaw=$('edit-importe').value.trim();
    const importeVal=importeRaw!==''?parseFloat(importeRaw):null;
    const fechaAccionVal=$('edit-proxima-accion').value||null;
    const editOpen=$('edit-panel').classList.contains('open');

    const payload={ estado:nuevoEstado, importe_presupuesto:importeVal, fecha_proxima_accion:fechaAccionVal };
    if(editOpen) {
      const n=$('edit-nombre').value.trim(), t=$('edit-tel').value.trim();
      const em=$('edit-email').value.trim(), p=$('edit-pobl').value.trim();
      if(n) payload.nombre_cliente=n;
      if(t) payload.telefono=t;
      if(em) payload.email=em;
      if(p) payload.poblacion=p;
    }

    try {
      const {error}=await sb.from('clientes').update(payload).eq('id',activeClienteId);
      if(error) throw error;

      activeClienteData={...activeClienteData,...payload};
      const idx=allLeads.findIndex(c=>c.id===activeClienteId);
      if(idx!==-1) allLeads[idx]={...allLeads[idx],...payload};

      $('modal-estado-pill').textContent=nuevoEstado;
      $('modal-estado-pill').className='pill '+(ESTADO_CLS[nuevoEstado]||'s-pendiente');
      if(payload.nombre_cliente) $('modal-client-name').textContent=payload.nombre_cliente;

      // Nota automÃ¡tica de ediciÃ³n
      const ahora=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
      await sb.from('comentarios_clientes').insert([{
        cliente_id:activeClienteId, nombre_autor:'Sistema', autor_id:null,
        texto:`Cambio realizado por gestor el ${ahora}`, created_at:new Date().toISOString(),
      }]);

      // Historial de estado si cambiÃ³
      if(nuevoEstado!==estadoAnterior) {
        await sb.from('comentarios_clientes').insert([{
          cliente_id:activeClienteId, nombre_autor:'Sistema', autor_id:null,
          texto:`Sistema: El estado ha cambiado a ${nuevoEstado}`, created_at:new Date().toISOString(),
        }]);
      }

      $('save-ok').style.display='inline';
      setTimeout(()=>{ $('save-ok').style.display='none'; },3000);
      $('save-bar').classList.remove('visible');
      $('edit-panel').classList.remove('open');
      toast('Cambios guardados');
      patchTableRow(activeClienteId, nuevoEstado);
      renderFiltrosEstado();

    } catch(err) {
      $('save-err').textContent='Error: '+err.message;
      $('save-err').style.display='inline';
    } finally { btn.disabled=false; btn.textContent='Guardar cambios'; }
  });

  function patchTableRow(id, nuevoEstado) {
    const row=document.querySelector(`#tbl-body tr[data-id="${id}"]`);
    if(!row) return;
    const cls=ESTADO_CLS[nuevoEstado]||'s-pendiente';
    const idx=rol==='empresa'?6:7;  // col estado depende de si hay col empresa
    const cell=row.querySelector(`td:nth-child(${idx})`);
    if(cell) cell.innerHTML=`<span class="pill ${cls}">${esc(nuevoEstado)}</span>`;
    row.style.transition='background .1s'; row.style.background='rgba(59,125,216,.18)';
    setTimeout(()=>{ row.style.background=''; },900);
    renderKPIs(leadsVisibles());
  }

  // â”€â”€â”€ BORRADO LÃ“GICO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function softDeleteLead(id, motivo) {
    const {error}=await sb.from('clientes').update({estado:'BORRADO',notas_internas:motivo}).eq('id',id);
    if(error) { toast('Error al borrar: '+error.message,'err'); return; }
    const lead=allLeads.find(c=>c.id===id);
    if(lead) { lead.estado='BORRADO'; lead.notas_internas=motivo; }
    closeModal();
    renderDashboard();
    toast('Lead movido a papelera');
  }

  // â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const {data:{session}}=await sb.auth.getSession();
    if(session) await enterApp(session.user);
  }

  $('form-login').addEventListener('submit', async e => {
    e.preventDefault(); clearAlert('err-login');
    const btn=$('btn-login'); btn.textContent='Verificandoâ€¦'; btn.disabled=true;
    try {
      const {data:auth,error}=await sb.auth.signInWithPassword({email:$('l-email').value.trim(),password:$('l-pass').value});
      if(error) throw new Error(error.message);
      await enterApp(auth.user);
    } catch(err) { setAlert('err-login','err-login-txt',err.message||'Error al iniciar sesiÃ³n.'); }
    finally { btn.textContent='Iniciar sesiÃ³n'; btn.disabled=false; }
  });

  // â”€â”€â”€ DETECCIÃ“N DE ROL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function enterApp(user) {
    const {data:gestor,error:gErr}=await sb.from('gestores').select('id,nombre,servicios').eq('auth_user_id',user.id).single();
    if(!gErr && gestor) {
      rol='gestor'; userId=gestor.id; userName=gestor.nombre||user.email.split('@')[0];
      servicios=Array.isArray(gestor.servicios)?gestor.servicios.map(String):[];
    } else {
      const {data:empresa,error:eErr}=await sb.from('empresas').select('id,nombre_comercial,servicios').eq('auth_user_id',user.id).single();
      if(eErr||!empresa) throw new Error('No se encontrÃ³ gestor ni empresa para este usuario.');
      rol='empresa'; userId=empresa.id; userName=empresa.nombre_comercial||user.email.split('@')[0];
      servicios=Array.isArray(empresa.servicios)?empresa.servicios.map(String):[];
    }

    applyRoleUI(user.email);
    await Promise.all([loadMarcas(),loadEmpresas()]);
    fillReformaSelector();

    if(rtClientes) { sb.removeChannel(rtClientes); rtClientes=null; }
    const rtFilter=rol==='gestor'?`gestor_id=eq.${userId}`:`empresa_id=eq.${userId}`;
    rtClientes=sb.channel(`clientes:${rol}:${userId}`)
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'clientes',filter:rtFilter},payload=>{
        const u=payload.new; if(!u?.id) return;
        const i=allLeads.findIndex(c=>c.id===u.id);
        if(i!==-1) allLeads[i]={...allLeads[i],...u}; else allLeads.unshift(u);
        patchTableRow(u.id,u.estado);
      })
      .subscribe();

    hideEl('screen-login');
    showEl('screen-app','flex');
  }

  // â”€â”€â”€ APPLY ROLE UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyRoleUI(email) {
    $('user-display-name').textContent=userName;
    $('user-badge').textContent=email.split('@')[0];

    if(rol==='gestor') {
      $('topbar-role-lbl').textContent='Panel Gestor';
      $('gestor-badge-form').textContent=userName;
      $('user-badge').className='badge mono';
      showEl('tab-btn-form','block');
      $('tab-btn-form').classList.add('active');
      $('tab-btn-dash').classList.remove('active');
      $('tab-form').classList.add('active');
      $('tab-dash').classList.remove('active');
      $('stats-card-title').textContent='Rendimiento por Empresa';
      showEl('kpi-wrap','block');
      showEl('stats-wrap','block');
      // Mostrar col empresa
      document.querySelectorAll('.th-empresa').forEach(th=>th.style.display='');
    } else {
      $('topbar-role-lbl').textContent='Panel Empresa';
      $('user-badge').className='badge badge-empresa mono';
      hideEl('tab-btn-form');
      $('tab-form').classList.remove('active');
      $('tab-btn-dash').classList.add('active');
      $('tab-dash').classList.add('active');
      $('stats-card-title').textContent='Actividad';
      // Ocultar KPIs y stats para empresa
      hideEl('kpi-wrap');
      hideEl('stats-wrap');
      // Ocultar col empresa
      document.querySelectorAll('.th-empresa').forEach(th=>th.style.display='none');
    }
  }

  // â”€â”€â”€ SECTOR MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sectoresDelUsuario() { return Object.keys(SECTOR_MAP).filter(s=>servicios.includes(s)); }
  function subserviciosDelUsuario() { return sectoresDelUsuario().flatMap(s=>SECTOR_MAP[s]); }

  function fillReformaSelector() {
    const ss=$('f-sector'), sr=$('f-reforma');
    if(!ss||!sr) return;
    const sectores=sectoresDelUsuario();
    while(ss.options.length>1) ss.remove(1);
    sectores.forEach(s=>ss.add(new Option(s,s)));
    if(!sectores.length) { ss.disabled=true; sr.disabled=true; return; }
    if(sectores.length===1) { ss.value=sectores[0]; ss.disabled=true; _poblarSubs(sectores[0]); }
    else { ss.disabled=false; ss.value=''; sr.disabled=true; }
  }

  function _poblarSubs(sector) {
    const sr=$('f-reforma'); if(!sr) return;
    const subs=SECTOR_MAP[sector]||[];
    sr.innerHTML='<option value="">â€” Seleccionar subservicio â€”</option>';
    subs.forEach(s=>sr.add(new Option(s,s)));
    sr.disabled=!subs.length;
  }

  $('f-sector').addEventListener('change',function(){ if(this.value) _poblarSubs(this.value); else { const r=$('f-reforma'); r.innerHTML='<option value="">â€” Elige un sector primero â€”</option>'; r.disabled=true; } });

  // Estado inicial segÃºn empresa
  $('f-empresa').addEventListener('change',function(){
    const lbl=$('estado-inicial-lbl');
    if(this.value) { lbl.textContent='PENDIENTE DE LLAMAR'; lbl.className='pill s-pendiente'; }
    else { lbl.textContent='PENDIENTE DE ASIGNAR'; lbl.className='pill s-sin-asignar'; }
  });

  // â”€â”€â”€ DROPDOWNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMarcas() {
    const {data}=await sb.from('marcas').select('id,nombre').order('nombre');
    marcasMap={}; const sel=$('f-marca');
    (data||[]).forEach(({id,nombre})=>{
      marcasMap[id]=nombre;
      marcasMap[String(id).trim().toLowerCase()]=nombre;
      if(sel) sel.add(new Option(nombre,id));
    });
  }

  async function loadEmpresas() {
    const {data}=await sb.from('empresas').select('id,nombre_comercial').order('nombre_comercial');
    empresasMap={}; const sel=$('f-empresa');
    (data||[]).forEach(({id,nombre_comercial})=>{
      empresasMap[id]=nombre_comercial;
      empresasMap[String(id).trim().toLowerCase()]=nombre_comercial;
      if(sel) sel.add(new Option(nombre_comercial,id));
    });
  }

  // â”€â”€â”€ SUBMIT LEAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('form-lead').addEventListener('submit', async e => {
    e.preventDefault(); if(rol!=='gestor') return;
    clearAlert('form-ok'); clearAlert('form-err');
    const btn=$('btn-lead-submit'); btn.textContent='Guardandoâ€¦'; btn.disabled=true;
    const str=id=>{ const v=$(id).value.trim(); return v||null; };
    const empresaId=str('f-empresa');
    const estadoInicial=empresaId?'PENDIENTE DE LLAMAR':'PENDIENTE DE ASIGNAR';
    try {
      const {data:nc,error:ce}=await sb.from('clientes').insert([{
        nombre_cliente:str('f-nombre'), telefono:str('f-tel'), email:str('f-email'),
        poblacion:str('f-pobl'), tipo_reforma:str('f-reforma'), marca_id:str('f-marca'),
        empresa_id:empresaId, gestor_id:userId, estado:estadoInicial,
      }]).select('id').single();
      if(ce) throw ce;
      const extra=$('f-extra').value.trim();
      if(extra) await sb.from('comentarios_clientes').insert([{cliente_id:nc.id,texto:extra,nombre_autor:userName,autor_id:userId,created_at:new Date().toISOString()}]);
      $('form-lead').reset(); $('f-extra').value=''; fillReformaSelector();
      $('estado-inicial-lbl').textContent='PENDIENTE DE ASIGNAR'; $('estado-inicial-lbl').className='pill s-sin-asignar';
      setAlert('form-ok',null,null); setTimeout(()=>clearAlert('form-ok'),6000);
      toast('Lead registrado Â· '+estadoInicial); loadDashboard();
    } catch(err) { setAlert('form-err','form-err-txt','Error: '+(err.message||JSON.stringify(err))); }
    finally { btn.textContent='Registrar lead'; btn.disabled=false; }
  });

  // â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDashboard() {
    showEl('tbl-loading','block'); hideEl('tbl-wrap'); hideEl('tbl-empty');
    if($('kpi-row')) $('kpi-row').innerHTML='<div class="kpi"><p class="kpi-lbl">Cargandoâ€¦</p></div>';
    if($('emp-grid')) $('emp-grid').innerHTML='<div class="empty">Cargandoâ€¦</div>';
    clientesConNuevoComentario=new Set();
    filtroEstado=null; filtroSector=null; filtroPapelera=false; filtroBusqueda='';
    const si=$('search-lead'); if(si) si.value='';

    let q=sb.from('clientes')
      .select('id,nombre_cliente,telefono,email,poblacion,tipo_reforma,marca_id,empresa_id,gestor_id,estado,created_at,updated_at,importe_presupuesto,fecha_proxima_accion')
      .order('created_at',{ascending:false});
    q=rol==='gestor'?q.eq('gestor_id',userId):q.eq('empresa_id',userId);

    const [leadsRes,commentsRes]=await Promise.all([
      q,
      sb.from('comentarios_clientes').select('cliente_id,created_at,autor_id').order('created_at',{ascending:false}),
    ]);
    hideEl('tbl-loading');
    if(leadsRes.error) { console.error(leadsRes.error); return; }

    let leads=leadsRes.data||[];
    const svs=subserviciosDelUsuario();
    if(svs.length) leads=leads.filter(l=>!l.tipo_reforma||svs.includes(String(l.tipo_reforma)));
    allLeads=leads;

    // Notificaciones
    const latest={};
    (commentsRes.data||[]).forEach(c=>{ if(!latest[c.cliente_id]) latest[c.cliente_id]=c; });
    clientesConNuevoComentario=new Set();
    allLeads.forEach(lead=>{
      const last=latest[lead.id]; if(!last) return;
      const esDeOtro=last.autor_id!==null&&last.autor_id!==userId;
      const esMasNuevo=new Date(last.created_at)>new Date(lead.updated_at||lead.created_at);
      if(esDeOtro&&esMasNuevo) clientesConNuevoComentario.add(lead.id);
    });

    renderDashboard();
  }

  // â”€â”€â”€ LEADS VISIBLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function leadsVisibles() {
    const q=filtroBusqueda.trim().toLowerCase();
    return allLeads.filter(c=>{
      if(filtroPapelera) return c.estado==='BORRADO';
      if(c.estado==='BORRADO') return false;
      if(filtroEstado && c.estado!==filtroEstado) return false;
      if(filtroSector) { const s=sectorDeReforma(c.tipo_reforma); if(s!==filtroSector) return false; }
      if(q) {
        const mn=getMarcaNombre(c.marca_id).toLowerCase();
        const campos=[(c.nombre_cliente||'').toLowerCase(),(c.telefono||'').toLowerCase(),(c.poblacion||'').toLowerCase(),mn];
        if(!campos.some(v=>v.includes(q))) return false;
      }
      return true;
    });
  }

  // â”€â”€â”€ RENDER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDashboard() {
    const vis=leadsVisibles();
    renderKPIs(vis);
    renderEmpresaStats(allLeads.filter(c=>c.estado!=='BORRADO'));
    renderFiltrosEstado();
    renderFiltrosSector();
    renderTable(vis);
  }

  function renderFiltrosEstado() {
    const row=$('filtros-estado-row'); if(!row) return;
    const activos=allLeads.filter(c=>c.estado!=='BORRADO');
    const nBorr=allLeads.filter(c=>c.estado==='BORRADO').length;

    let html=`<button class="sf-btn${!filtroEstado&&!filtroPapelera?' active':''}" onclick="window.__fe(null)">TODOS</button>`;
    ESTADOS.filter(e=>e!=='BORRADO').forEach(e=>{
      const n=activos.filter(c=>c.estado===e).length; if(!n) return;
      const act=!filtroPapelera&&filtroEstado===e?' active':'';
      html+=`<button class="sf-btn${act}" onclick="window.__fe('${e.replace(/'/g,"\\'")}')">
        <span class="pill ${ESTADO_CLS[e]||''}" style="font-size:.55rem;padding:1px 5px;margin-right:4px">${n}</span>${esc(e)}
      </button>`;
    });
    if(rol==='gestor') {
      html+=`<button class="sf-btn papelera${filtroPapelera?' active':''}" onclick="window.__fp()">ðŸ—‘ Papelera${nBorr?` <span style="opacity:.7;margin-left:3px">${nBorr}</span>`:''}</button>`;
    }
    row.innerHTML=html;
  }

  function renderFiltrosSector() {
    const row=$('filtros-sector-row'); if(!row||rol!=='gestor') return;
    const sectores=sectoresDelUsuario();
    if(sectores.length<2) { row.innerHTML=''; return; }
    let html=`<span style="font-size:.62rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-right:4px">Sector:</span>`;
    html+=`<button class="sf-btn${!filtroSector?' active':''}" onclick="window.__fs(null)">Todos</button>`;
    sectores.forEach(s=>{ html+=`<button class="sf-btn${filtroSector===s?' active':''}" onclick="window.__fs('${s}')">${esc(s.charAt(0)+s.slice(1).toLowerCase())}</button>`; });
    row.innerHTML=html;
  }

  window.__fe = s  => { filtroEstado=s; filtroPapelera=false; renderDashboard(); };
  window.__fp = () => { filtroPapelera=!filtroPapelera; filtroEstado=null; renderDashboard(); };
  window.__fs = s  => { filtroSector=s; renderDashboard(); };

  $('search-lead').addEventListener('input', function(){ filtroBusqueda=this.value; renderKPIs(leadsVisibles()); renderTable(leadsVisibles()); });

  // â”€â”€â”€ RENDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderKPIs(data) {
    const el=$('kpi-row'); if(!el||rol!=='gestor') return;
    const total=data.length;
    const ganados=data.filter(c=>['OBRA ACEPTADA','TRABAJANDO'].includes(c.estado)).length;
    const pend=data.filter(c=>c.estado==='PENDIENTE DE LLAMAR').length;
    const rechaz=data.filter(c=>c.estado==='RECHAZADO').length;
    const tasa=total>0?Math.round(ganados/total*100):0;
    el.innerHTML=[
      {lbl:'Total Leads',val:total,color:'#e6f0ff'},
      {lbl:'Obras Aceptadas',val:ganados,color:'#4ade80'},
      {lbl:'Pendientes',val:pend,color:'#f5a623'},
      {lbl:'Rechazados',val:rechaz,color:'#f87171'},
      {lbl:'Tasa de Ã‰xito',val:tasa+'%',color:ganados>0?'#4ade80':'#3d5a78'},
    ].map(k=>`<div class="kpi"><p class="kpi-lbl">${esc(k.lbl)}</p><p class="kpi-val" style="color:${k.color}">${esc(String(k.val))}</p></div>`).join('');
  }

  function renderEmpresaStats(data) {
    const el=$('emp-grid'); if(!el) return;
    if(!data.length) { el.innerHTML='<div class="empty">Sin datos.</div>'; return; }
    const gk=rol==='gestor'?'empresa_id':'gestor_id';
    const gl=id=>!id?null:rol==='gestor'?(empresasMap[id]||'Empresa desconocida'):'Gestor '+id.slice(0,8)+'â€¦';
    const byG={};
    data.forEach(c=>{ const k=c[gk]||'__none__'; if(!byG[k]) byG[k]={}; byG[k][c.estado]=(byG[k][c.estado]||0)+1; });
    el.innerHTML=Object.entries(byG).map(([gid,counts])=>{
      const label=gid==='__none__'?'<em style="color:var(--muted)">Sin asignar</em>':esc(gl(gid));
      const rows=Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([e,n])=>`
        <div class="emp-row">
          <span style="display:flex;align-items:center"><span class="estat-dot" style="background:${ESTADO_DOT[e]||'#3d5a78'}"></span><span style="font-size:.74rem">${esc(e)}</span></span>
          <span class="pill ${ESTADO_CLS[e]||''}">${n}</span>
        </div>`).join('');
      return `<div class="emp-card"><div class="emp-name">${label}</div>${rows}</div>`;
    }).join('');
  }

  function renderTable(data) {
    hideEl('tbl-loading');
    if(!data.length) { showEl('tbl-empty','block'); hideEl('tbl-wrap'); return; }
    hideEl('tbl-empty'); showEl('tbl-wrap','block');

    $('tbl-body').innerHTML=data.map(c=>{
      const cls=ESTADO_CLS[c.estado]||'s-pendiente';
      const marcaNomTxt=getMarcaNombre(c.marca_id);
      const marcaNom=marcaNomTxt?`<span style="font-size:.8rem">${esc(marcaNomTxt)}</span>`:'<span style="color:var(--muted)">â€”</span>';
      const hasNew=clientesConNuevoComentario.has(c.id);
      const notif=hasNew?'<span class="new-comment-dot">nuevo comentario</span>':'<span class="row-hint">Ver ficha â†’</span>';
      const {txt:fechaTxt,cls:fechaCls}=semaforo(c.fecha_proxima_accion||null);
      const fechaEntrada=c.created_at?fmtDate(c.created_at):'â€”';

      // Celda telÃ©fono clicable
      const telClean=(c.telefono||'').replace(/\s/g,'');
      const telHtml=telClean
        ?`<span class="tel-cell" onclick="event.stopPropagation();_openTelPopup(event,'${esc(telClean)}')" title="Llamar o WhatsApp">${esc(c.telefono)}</span>`
        :'<span style="color:var(--muted)">â€”</span>';

      // Empresa: gestor ve el nombre, empresa no ve esta columna
      const empNom=c.empresa_id?(empresasMap[c.empresa_id]||empresasMap[String(c.empresa_id).trim().toLowerCase()]||'â€”'):'â€”';
      const empCell=rol==='gestor'
        ?`<td style="font-size:.8rem;display:${rol==='empresa'?'none':''}">${esc(empNom)}</td>`
        :'';

      // BotÃ³n eliminar solo gestor
      const delBtn=rol==='gestor'
        ?`<button class="btn-row-del" onclick="event.stopPropagation();_rowDel('${esc(c.id)}')" title="Mover a papelera">ðŸ—‘</button>`
        :'';

      return `
        <tr data-id="${esc(c.id)}" title="Clic para abrir la ficha">
          <td style="font-weight:500;color:#dce8f8">${esc(c.nombre_cliente||'â€”')}</td>
          <td>${telHtml}</td>
          <td>${esc(c.poblacion||'â€”')}</td>
          <td style="font-size:.76rem;color:var(--muted)">${esc(fechaEntrada)}</td>
          ${empCell}
          <td>${marcaNom}</td>
          <td><span class="pill ${cls}">${esc(c.estado||'â€”')}</span></td>
          <td><span class="${fechaCls}" style="font-size:.78rem;white-space:nowrap">${esc(fechaTxt)}</span></td>
          <td>${notif}</td>
          <td>${delBtn}</td>
        </tr>`;
    }).join('');

    // Click en filas â†’ abrir modal
    $('tbl-body').querySelectorAll('tr').forEach(row=>{
      row.addEventListener('click',e=>{
        if(e.target.closest('.tel-cell')||e.target.closest('.btn-row-del')) return;
        const id=row.dataset.id;
        const cliente=allLeads.find(c=>c.id===id);
        if(!cliente) return;
        clientesConNuevoComentario.delete(id);
        const last=row.querySelector('td:last-child');
        if(last) last.innerHTML='<span class="row-hint">Ver ficha â†’</span>';
        openModal(cliente);
      });
    });

    // Ocultar columna empresa para rol empresa
    if(rol==='empresa') {
      document.querySelectorAll('.th-empresa').forEach(th=>th.style.display='none');
      $('tbl-body').querySelectorAll('tr').forEach(row=>{
        // La empresa no tiene empCell, ya se excluye del HTML
      });
    }
  }

  // â”€â”€â”€ POPUP TELÃ‰FONO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window._openTelPopup = function(e, tel) {
    const popup=$('tel-popup');
    $('tel-call').href='tel:'+tel;
    $('tel-wa').href='https://wa.me/'+tel.replace(/^\+/,'').replace(/^00/,'');
    popup.style.position='fixed';
    popup.style.top=(e.clientY+10)+'px';
    popup.style.left=(e.clientX)+'px';
    popup.classList.add('open');
    const close=ev=>{ if(!popup.contains(ev.target)){ popup.classList.remove('open'); document.removeEventListener('click',close); } };
    setTimeout(()=>document.addEventListener('click',close),10);
  };

  // â”€â”€â”€ BORRADO DESDE FILA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window._rowDel = async function(id) {
    if(rol!=='gestor') return;
    const motivo=prompt('Motivo de borrado (obligatorio):');
    if(motivo===null||!motivo.trim()) { toast('Borrado cancelado: motivo obligatorio','err'); return; }
    await softDeleteLead(id,motivo.trim());
  };

  // â”€â”€â”€ COMENTARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadComments(clienteId) {
    showEl('comments-loading','block'); hideEl('comments-list'); hideEl('comments-empty');
    const {data,error}=await sb.from('comentarios_clientes').select('id,texto,nombre_autor,autor_id,created_at').eq('cliente_id',clienteId).order('created_at',{ascending:true});
    hideEl('comments-loading');
    if(error) { toast('Error al cargar comentarios: '+error.message,'err'); return; }
    if(!data||!data.length) { showEl('comments-empty','block'); return; }
    showEl('comments-list','flex');
    $('comments-list').style.flexDirection='column';
    $('comments-list').innerHTML=data.map(c=>{
      const esSistema=c.nombre_autor==='Sistema';
      return `<div class="comment-bubble${esSistema?' sistema':''}">
        <div class="comment-meta">
          <span class="comment-author${esSistema?' sistema':''}">${esc(c.nombre_autor||'Desconocido')}</span>
          <span class="comment-date">${fmtDate(c.created_at,true)}</span>
        </div>
        <div class="comment-text">${esc(c.texto)}</div>
      </div>`;
    }).join('');
    const list=$('comments-list'); list.scrollTop=list.scrollHeight;
  }

  $('btn-send-comment').addEventListener('click', async () => {
    clearAlert('comment-err');
    const texto=$('comment-input').value.trim();
    if(!texto) { setAlert('comment-err','comment-err-txt','Escribe algo antes de enviar.'); return; }
    if(!activeClienteId) return;
    const btn=$('btn-send-comment'); btn.textContent='â€¦'; btn.disabled=true;
    try {
      const {error}=await sb.from('comentarios_clientes').insert([{cliente_id:activeClienteId,texto,nombre_autor:userName,autor_id:userId}]);
      if(error) throw error;
      $('comment-input').value=''; await loadComments(activeClienteId); toast('Comentario guardado');
    } catch(err) { setAlert('comment-err','comment-err-txt','Error: '+(err.message||JSON.stringify(err))); }
    finally { btn.textContent='Enviar'; btn.disabled=false; }
  });
  $('comment-input').addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') $('btn-send-comment').click(); });

  // â”€â”€â”€ DOCUMENTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDocs(clienteId) {
    showEl('docs-loading','block'); hideEl('doc-list'); hideEl('docs-empty'); clearAlert('docs-err');
    const {data,error}=await sb.storage.from(BUCKET).list(clienteId,{sortBy:{column:'created_at',order:'desc'}});
    hideEl('docs-loading');
    if(error) { setAlert('docs-err','docs-err-txt','Error al cargar documentos: '+error.message); return; }
    const files=(data||[]).filter(f=>f.name&&f.name!=='.emptyFolderPlaceholder');
    if(!files.length) { showEl('docs-empty','block'); return; }
    showEl('doc-list','flex'); $('doc-list').style.flexDirection='column';
    $('doc-list').innerHTML=files.map(f=>`
      <div class="doc-item">
        <span class="doc-icon">${docIcon(f.name)}</span>
        <span class="doc-name" title="${esc(f.name)}">${esc(f.name)}</span>
        <span class="doc-size">${f.metadata?.size?fmtBytes(f.metadata.size):''}</span>
        <button class="btn-sm btn-sm-green" onclick="window.__dl('${esc(clienteId)}','${esc(f.name)}',this)">â†“ Descargar</button>
      </div>`).join('');
  }
  window.__dl=async(cId,fn,btn)=>{
    btn.textContent='â€¦'; btn.disabled=true;
    const {data,error}=await sb.storage.from(BUCKET).createSignedUrl(`${cId}/${fn}`,60);
    btn.textContent='â†“ Descargar'; btn.disabled=false;
    if(error) { toast('Error al generar enlace: '+error.message,'err'); return; }
    const a=document.createElement('a'); a.href=data.signedUrl; a.download=fn; a.target='_blank';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  const dz=$('drop-zone'), fi=$('file-input');
  dz.addEventListener('dragover',e=>{ e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop',e=>{ e.preventDefault(); dz.classList.remove('dragover'); handleFiles([...e.dataTransfer.files]); });
  fi.addEventListener('change',()=>{ handleFiles([...fi.files]); fi.value=''; });

  async function handleFiles(files) {
    if(!activeClienteId) return;
    clearAlert('docs-err');
    const valid=[];
    for(const f of files) {
      if(f.size>MAX_SIZE) { toast(`${f.name}: supera 5 MB`,'err'); continue; }
      const ext='.'+f.name.split('.').pop().toLowerCase();
      if(!ALLOWED_EXT.includes(ext)) { toast(`${f.name}: formato no permitido`,'err'); continue; }
      valid.push(f);
    }
    if(!valid.length) return;
    const bar=$('upload-progress-bar'), lbl=$('upload-progress-label');
    showEl('upload-progress-wrap','block');
    for(let i=0;i<valid.length;i++) {
      const f=valid[i]; bar.style.width=Math.round(i/valid.length*100)+'%';
      lbl.textContent=`Subiendo ${i+1} de ${valid.length}: ${f.name}`;
      const {error}=await sb.storage.from(BUCKET).upload(`${activeClienteId}/${f.name}`,f,{upsert:true});
      error?toast(`Error subiendo ${f.name}: ${error.message}`,'err'):toast(`${f.name} subido`);
    }
    bar.style.width='100%'; lbl.textContent='Completado';
    setTimeout(()=>hideEl('upload-progress-wrap'),1200);
    await loadDocs(activeClienteId);
  }

  // â”€â”€â”€ REFRESH & LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('btn-refresh').addEventListener('click',()=>{ if(userId) loadDashboard(); });

  $('btn-logout').addEventListener('click', async () => {
    if(rtComments) { sb.removeChannel(rtComments); rtComments=null; }
    if(rtClientes) { sb.removeChannel(rtClientes); rtClientes=null; }
    await sb.auth.signOut();
    rol=null; userId=null; userName=''; servicios=[]; allLeads=[];
    closeModal();
    $('screen-app').style.display='none';
    showEl('screen-login','flex');
    $('form-login').reset(); clearAlert('err-login');
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    showEl('tab-btn-form','block');
    $('tab-btn-form').classList.add('active');
    $('tab-form').classList.add('active');
  });

  sb.auth.onAuthStateChange(ev=>{
    if(ev==='SIGNED_OUT') {
      if(rtComments) { sb.removeChannel(rtComments); rtComments=null; }
      if(rtClientes) { sb.removeChannel(rtClientes); rtClientes=null; }
      rol=null; userId=null; allLeads=[];
      $('screen-app').style.display='none';
      showEl('screen-login','flex');
    }
  });

  init().catch(err=>console.error('Init error:',err));
})();
</script>
</body>
</html>
